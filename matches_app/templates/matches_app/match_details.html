{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>{{ match.home_team.name }} vs {{ match.away_team.name }}</h2>
    <p class="text-muted">{{ match.date|date:"M d, Y" }}</p>

    <!-- âœ… Live Match Time -->
    <p><strong>Match Time:</strong> <span id="match-time">Loading...</span></p>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="matchTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">Info</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">Summary</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">Stats</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="lineup-tab" data-bs-toggle="tab" data-bs-target="#lineup" type="button" role="tab">Line-up</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="h2h-tab" data-bs-toggle="tab" data-bs-target="#h2h" type="button" role="tab">H2H</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mt-3" id="matchTabsContent">
        <!-- Info Tab -->
        <div class="tab-pane fade show active" id="info" role="tabpanel">
            <h5>Match Information</h5>
            <p><strong>Date:</strong> {{ match.date }}</p>
            <p><strong>Venue:</strong> {{ match.venue }}</p>
            <p><strong>Competition:</strong> {{ match.competition_type }}</p>
        </div>

        <!-- Summary Tab -->
        <div class="tab-pane fade" id="summary" role="tabpanel">
            <h5>Match Summary</h5>
            {% if match.summary %}
                <p>{{ match.summary }}</p>
            {% else %}
                <p>No summary available yet.</p>
            {% endif %}
        </div>

        <!-- Stats Tab -->
        <div class="tab-pane fade" id="stats" role="tabpanel">
            <h5>Match Stats</h5>
            <p>Shots, passes, duels, etc. will go here.</p>

            <h6>General Stats</h6>
            <table class="table table-bordered text-center">
                <thead>
                    <tr>
                        <th></th>
                        <th>{{ match.home_team.name }}</th>
                        <th>{{ match.away_team.name }}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Shots (on target)</td>
                        <td>{{ stats.home.shots_on }}</td>
                        <td>{{ stats.away.shots_on }}</td>
                    </tr>
                    <tr>
                        <td>Shots (off target)</td>
                        <td>{{ stats.home.shots_off }}</td>
                        <td>{{ stats.away.shots_off }}</td>
                    </tr>
                    <tr>
                        <td>Corners</td>
                        <td>{{ stats.home.corners }}</td>
                        <td>{{ stats.away.corners }}</td>
                    </tr>
                    <tr>
                        <td>Fouls</td>
                        <td>{{ stats.home.fouls }}</td>
                        <td>{{ stats.away.fouls }}</td>
                    </tr>
                    <tr>
                        <td>Yellow Cards</td>
                        <td>{{ stats.home.yellow }}</td>
                        <td>{{ stats.away.yellow }}</td>
                    </tr>
                </tbody>
            </table>

            <h6>Passing</h6>
            <ul>
                <li>{{ match.home_team.name }}: {{ stats.home.total_passes }} passes ({{ stats.home.pass_accuracy }}% accuracy)</li>
                <li>{{ match.away_team.name }}: {{ stats.away.total_passes }} passes ({{ stats.away.pass_accuracy }}% accuracy)</li>
            </ul>
            <a href="{% url 'tagging_app:pass_network_dashboard' match.id %}">ðŸ”— View Pass Network</a>
        </div>

        <!-- Lineup Tab -->
        <div class="tab-pane fade" id="lineup" role="tabpanel">
            <div id="pitch-container" style="position:relative; width:100%; max-width:800px; height:500px; background:#6aa84f; margin:auto; border:2px solid #333; border-radius:10px;">
                <!-- Home Team -->
                {% for player in home_lineup %}
                <div style="
                    position:absolute;
                    top:{{ player.top }}%;
                    left:{{ player.left }}%;
                    transform:translate(-50%, -50%);
                    background:#007bff;
                    color:white;
                    padding:5px 8px;
                    border-radius:50%;
                    text-align:center;
                    font-size:12px;
                ">
                    {{ player.number }}<br>{{ player.name }}
                </div>
                {% endfor %}

                <!-- Away Team -->
                {% for player in away_lineup %}
                <div style="
                    position:absolute;
                    top:{{ player.top }}%;
                    left:{{ player.left }}%;
                    transform:translate(-50%, -50%);
                    background:#ff4d4d;
                    color:white;
                    padding:5px 8px;
                    border-radius:50%;
                    text-align:center;
                    font-size:12px;
                ">
                    {{ player.number }}<br>{{ player.name }}
                </div>
                {% endfor %}
            </div>

            <div style="text-align:center; margin-top:10px;">
                <a href="{% url 'lineup_app:substitution_panel' match.id %}" class="btn btn-primary">
                    View Full Lineup
                </a>
            </div>
        </div>

        <!-- H2H Tab -->
        <div class="tab-pane fade" id="h2h" role="tabpanel">
            <h5>Head-to-Head</h5>
            {% if h2h_results %}
                <ul>
                    {% for result in h2h_results %}
                        <li>{{ result }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No past meetings available.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    var triggerTabList = [].slice.call(document.querySelectorAll('#matchTabs button'))
    triggerTabList.forEach(function(triggerEl) {
        var tabTrigger = new bootstrap.Tab(triggerEl)

        triggerEl.addEventListener('click', function (event) {
            event.preventDefault()
            tabTrigger.show()
        })
    })

    // âœ… Live Match Time Script
    const matchId = {{ match.id }};
    function updateMatchTime() {
      fetch(`/matches/match/${matchId}/time/`)
        .then(response => response.json())
        .then(data => {
          document.getElementById("match-time").innerText = `${data.minute}' (${data.status})`;
        })
        .catch(error => console.error("Error fetching match time:", error));
    }
    setInterval(updateMatchTime, 10000);
    updateMatchTime();
});
</script>

<hr style="margin: 40px 0;">

<a href="{% url 'tagging_app:pass_network_dashboard' match.id %}" style="padding: 8px 14px; background: #007BFF; color: white; text-decoration: none; border-radius: 5px;">
    ðŸ“Š View Pass Network
</a> | 
<a href="{% url 'tagging_app:attempt_to_goal_dashboard' match.id %}" style="padding: 8px 14px; background: #007BFF; color: white; text-decoration: none; border-radius: 5px;">
    ðŸ“Š View Goal Attempts
</a> | 
<a href="{% url 'tagging_app:goalkeeper_distribution_dashboard' match.id %}" style="padding: 8px 14px; background: #007BFF; color: white; text-decoration: none; border-radius: 5px;">
    ðŸ“Š View Goalkeeping Distribution
</a> | 
<a href="{% url 'defensive_app:defensive_summary' match.id  %}"  style="padding: 8px 14px; background: #007BFF; color: white; text-decoration: none; border-radius: 5px;">
    ðŸ“Š View Other statistics
</a> 

</div>
{% endblock %}

{% load static %}
{% load defensive_custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Defensive</title>
<style>
    body { font-family: Arial, sans-serif; padding: 10px; margin:0; }
    #events, #players { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    #players { display: none; }
    .event-btn, .player-btn, .card-btn {
        padding: 10px 14px; border: 1px solid #007bff; border-radius: 6px;
        cursor: pointer; user-select: none; background-color: white; min-width: 90px;
        text-align: center; font-weight: 600; flex-grow: 1; flex-basis: 28%; box-sizing: border-box;
    }
    .event-btn.selected { background-color: #007bff; color: white; font-weight: 700; }
    .player-btn { min-width: 60px; font-size: 0.9em; flex-basis: 30%; display: flex; flex-direction: column; align-items: center; }
    .player-photo { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 4px; object-fit: cover; }
    .player-name { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; margin-bottom: 4px; }
    .count { font-size: 0.85em; color: #333; font-weight: 700; display: block; }
    #clear-selection { margin-bottom: 20px; cursor: pointer; color: #dc3545; font-weight: 600; display: none; user-select: none; }
    #card-options { display: none; gap: 10px; margin-bottom: 20px; }
    h2, h3 { margin: 0 0 10px 0; font-weight: 700; }
    @media (max-width: 600px) { .event-btn, .player-btn, .card-btn { flex-basis: 48%; font-size: 1em; min-width: auto; } body { padding: 8px; } }

    /* Card button colors */
    .card-btn[data-card="yellow"] {
        background-color: #ffc107;
        border-color: #e0a800;
        color: #000;
        font-weight: 700;
    }
    .card-btn[data-card="red"] {
        background-color: #dc3545;
        border-color: #c82333;
        color: #fff;
        font-weight: 700;
    }
    .card-btn[data-card="none"] {
        background-color: white;
        border-color: #6c757d;
        color: #000;
        font-weight: 600;
    }
    .card-btn:hover { opacity: 0.85; }
</style>
</head>
<body>
<h2>Defensive Tagging - {{ match }}</h2>

<h3>Select Event (click again to clear):</h3>
<div id="events">
    {% for event_key, event_label in events %}
    <div class="event-btn" data-event="{{ event_key }}">{{ event_label }}</div>
    {% endfor %}
</div>

<div id="clear-selection">Clear event selection</div>

<h3>Select Player who did it:</h3>
<div id="players">
    {% for player in players %}
        <div class="player-btn" data-player-id="{{ player.id }}">
            <img class="player-photo" src="{{ player.photo.url }}" alt="{{ player.name }}">
            <span class="player-name">{{ player.name|slice:":7" }}</span>
            <span class="count" id="count-{{ player.id }}"></span>
        </div>
    {% endfor %}
</div>

<div id="card-options">
    <div class="card-btn" data-card="yellow">YELLOW CARD</div>
    <div class="card-btn" data-card="red">RED CARD</div>
    <div class="card-btn" data-card="none">NO CARD</div>
</div>

<script>
let selectedEvent = null;
let selectedPlayerId = null;

function resetProcess() {
    selectedEvent = null;
    selectedPlayerId = null;
    document.querySelectorAll('.event-btn').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('players').style.display = 'none';
    document.getElementById('card-options').style.display = 'none';
    document.getElementById('clear-selection').style.display = 'none';
}

document.getElementById('clear-selection').onclick = resetProcess;

// Event selection
document.querySelectorAll('.event-btn').forEach(btn => {
    btn.onclick = () => {
        if(selectedEvent === btn.dataset.event) { resetProcess(); return; }
        selectedEvent = btn.dataset.event;
        selectedPlayerId = null;
        document.querySelectorAll('.event-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('clear-selection').style.display = 'block';
        document.getElementById('players').style.display = 'flex';
        document.getElementById('card-options').style.display = 'none';
    };
});

// Player selection
document.querySelectorAll('.player-btn').forEach(btn => {
    btn.onclick = () => {
        if(!selectedEvent) { alert('Select an event first'); return; }
        selectedPlayerId = btn.dataset.playerId;

        if(selectedEvent === "foul_committed" || selectedEvent === "foul_won") {
            document.getElementById('card-options').style.display = 'flex';
        } else {
            saveEvent(selectedPlayerId, selectedEvent, null);
            resetProcess();
        }
    };
});

// Card selection
document.querySelectorAll('.card-btn').forEach(btn => {
    btn.onclick = () => {
        if(!selectedPlayerId || !selectedEvent) return;
        let card = btn.dataset.card === "none" ? null : btn.dataset.card;
        saveEvent(selectedPlayerId, selectedEvent, card);
        resetProcess();
    };
});

function saveEvent(playerId, event, card) {
    let time = new Date().toISOString();
    fetch(`/defensive/{{ match.id }}/record/`, {   // âœ… Corrected URL
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json', 
            'X-CSRFToken': '{{ csrf_token }}' 
        },
        body: JSON.stringify({ player_id: playerId, event: event, card: card, time: time })
    })
    .then(res => res.json())
    .then(data => {
        if(data.status === 'ok') {
            const countSpan = document.getElementById(`count-${data.player_id}`);
            if (countSpan) {
                countSpan.textContent = `${data.event.replace(/_/g,' ')}: ${data.new_value}`;
            }
        } else {
            alert(data.message || 'Error recording event');
        }
    });
}
</script>

</body>
</html>

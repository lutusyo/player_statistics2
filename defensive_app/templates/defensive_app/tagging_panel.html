{% load static %}
{% load defensive_custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Defensive</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 10px; margin:0; }
        #events, #players { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        #players { display: none; }  /* hide initially */
        .event-btn, .player-btn {
            padding: 10px 14px;
            border: 1px solid #007bff;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            background-color: white;
            min-width: 90px;
            text-align: center;
            font-weight: 600;
            flex-grow: 1;
            flex-basis: 28%;
            box-sizing: border-box;
        }
        .event-btn.selected {
            background-color: #007bff;
            color: white;
            font-weight: 700;
        }
        .player-btn {
            min-width: 60px;
            font-size: 0.9em;
            flex-basis: 30%;
        }
        .player-name {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            margin-bottom: 4px;
        }
        .count {
            font-size: 0.85em;
            color: #333;
            font-weight: 700;
        }
        #clear-selection {
            margin-bottom: 20px;
            cursor: pointer;
            color: #dc3545;
            font-weight: 600;
            display: none;  /* hide initially */
            user-select: none;
        }
        h2, h3 {
            margin: 0 0 10px 0;
            font-weight: 700;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .event-btn, .player-btn {
                flex-basis: 48%;
                font-size: 1em;
                min-width: auto;
            }
            body {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
<h2>Defensive Tagging - {{ match }}</h2>

<h3>Select Event (click again to clear):</h3>
<div id="events">
    {% for event_key, event_label in events %}
    <div class="event-btn" data-event="{{ event_key }}">{{ event_label }}</div>
    {% endfor %}
</div>

<div id="clear-selection">Clear event selection</div>

<h3>Select Player who did it:</h3>
<div id="players">
    {% for player in players %}
        {% with stat=stats|get_item:player.id %}
            <div class="player-btn" data-player-id="{{ player.id }}">
                <span class="player-name">{{ player.name|slice:":7" }}</span>
                <span class="count" data-event-count></span>
            </div>
        {% endwith %}
    {% endfor %}
</div>

<script>
    let selectedEvent = null;

    function clearSelection() {
        selectedEvent = null;
        document.querySelectorAll('.event-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('clear-selection').style.display = 'none';
        document.getElementById('players').style.display = 'none';  // hide players on clear
        updateCountsDisplay();
    }

    document.getElementById('clear-selection').onclick = clearSelection;

    // Event selection
    document.querySelectorAll('.event-btn').forEach(btn => {
        btn.onclick = () => {
            if(selectedEvent === btn.dataset.event) {
                clearSelection();
                return;
            }
            selectedEvent = btn.dataset.event;
            document.querySelectorAll('.event-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('clear-selection').style.display = 'block';
            document.getElementById('players').style.display = 'flex';  // show players on event select
            updateCountsDisplay();
        };
    });

    // Player click to record event
    document.querySelectorAll('.player-btn').forEach(btn => {
        btn.onclick = () => {
            if (!selectedEvent) {
                alert('Please select an event first.');
                return;
            }
            let playerId = btn.dataset.playerId;

            fetch("{% url 'defensive_app:record_event' match.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    player_id: playerId,
                    event: selectedEvent
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'ok') {
                    updateCountsDisplay(data.player_id, data.event, data.new_value);

                    // After saving, clear event selection & hide players
                    clearSelection();
                } else {
                    alert(data.message || 'Error recording event');
                }
            });
        };
    });

    // Update counts display on player buttons
    function updateCountsDisplay(updatedPlayerId=null, updatedEvent=null, updatedValue=null) {
        const players = document.querySelectorAll('.player-btn');
        players.forEach(btn => {
            let pid = btn.dataset.playerId;
            let countSpan = btn.querySelector('[data-event-count]');
            if (!countSpan) return;

            if (pid === updatedPlayerId && updatedEvent) {
                countSpan.textContent = `${updatedEvent.replace(/_/g,' ')}: ${updatedValue}`;
            } else if (!updatedPlayerId) {
                countSpan.textContent = '';
            }
        });
    }
</script>
</body>
</html>

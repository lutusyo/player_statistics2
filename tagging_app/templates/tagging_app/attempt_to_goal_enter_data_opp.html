<!-- tagging_app/templates/tagging_app/opponent_attempt_to_goal_enter_data.html -->
{% extends 'base.html' %}
{% block content %}
<h3>Tag Opponent Attempt to Goal</h3>

<div id="opponent-tag-panel" class="tag-panel responsive-panel">
  <div id="outcome-panel" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
    {% for value, label in outcomes %}
      <button class="outcome-btn" data-outcome="{{ value }}">{{ label }}</button>
    {% endfor %}
  </div>

  <div id="delivery-panel" style="display: none; grid-template-columns: repeat(4, 1fr); gap: 10px;">
    {% for value, label in delivery_types %}
      <button class="delivery-btn" data-delivery-type="{{ value }}">{{ label }}</button>
    {% endfor %}
  </div>
</div>

<script>
let selectedOutcome = null, selectedDeliveryType = null;
const matchId = {{ match.id }};
let timer = parseInt(sessionStorage.getItem('tagging-timer')) || 0;

document.querySelectorAll('.outcome-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    selectedOutcome = btn.dataset.outcome;
    document.getElementById('outcome-panel').style.display = 'none';
    document.getElementById('delivery-panel').style.display = 'grid';
  });
});

document.querySelectorAll('.delivery-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    selectedDeliveryType = btn.dataset.deliveryType;
    const payload = {
      match_id: matchId,
      outcome: selectedOutcome,
      delivery_type: selectedDeliveryType,
      minute: Math.floor(timer / 60),
      second: timer % 60,
      timestamp: new Date().toISOString(),
      is_opponent: true  // ðŸ‘ˆ important!
    };

    fetch("{% url 'tagging_app:save_opponent_attempt_to_goal' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(json => {
      if (json.status === 'ok') {
        alert("Opponent attempt tagged successfully");
        location.reload();
      } else {
        alert(json.message);
      }
    });
  });
});
</script>
{% endblock %}

{% load static %}

{% load static %}

<title>Passing Network Tagging</title>
<style>
#pass-network {
    margin: 20px 0;
}

/* Grid for our players */
#our-players {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
}

/* Full-width on mobile */
@media (max-width: 768px) {
    #our-players {
        grid-template-columns: 1fr;
    }
}

/* Player button with photo */
.player-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
    background-color: lightblue;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
}

.player-btn img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 5px;
}

.player-btn.active {
    background-color: green !important;
    color: white;
}

.opponent-btn {
    padding: 10px 20px;
    margin-top: 10px;
    background-color: lightcoral;
    border: none;
    cursor: pointer;
    border-radius: 5px;
}
</style>

<div id="pass-network">
    <div id="our-players">
        {% for p in our_players %}
            <button class="player-btn"
                    id="player-{{ p.player.id }}"
                    data-player-id="{{ p.player.id }}"
                    data-team-id="{{ our_team.id }}">
                {% if p.player.photo %}
                    <img src="{{ p.player.photo.url }}" alt="{{ p.player.name }}">
                {% else %}
                    <img src="{% static 'default_player.png' %}" alt="{{ p.player.name }}">
                {% endif %}
                {{ p.player.name }}
                <span class="pass-count">0</span>
            </button>
        {% endfor %}
    </div>

    <div>
        <button class="opponent-btn" id="opponent-btn" data-team-id="{{ opponent_team.id }}">
            {{ opponent_team.name }} Ball Intercept
        </button>
    </div>

    <p><strong>Last Pass:</strong> <span id="last-pass"></span></p>
</div>


<script>
window.PassNetwork = {
    matchId: {{ match.id }},
    lastPlayerId: null,
    lastTeamId: null,
    minute: 0,
    second: 0,
    passCounts: JSON.parse(localStorage.getItem('passCounts') || '{}'),

    init: function () {
        this.restoreCounts();
        this.bindEvents();
        this.updateTimer();
        setInterval(this.updateTimer.bind(this), 1000);
    },

    updateTimer: function () {
        let startTimestamp = localStorage.getItem('passNetworkStartTimestamp');
        if (!startTimestamp) {
            startTimestamp = new Date().toISOString();
            localStorage.setItem('passNetworkStartTimestamp', startTimestamp);
        }
        const start = new Date(startTimestamp);
        const now = new Date();
        const diff = Math.floor((now - start) / 1000);
        this.minute = Math.floor(diff / 60);
        this.second = diff % 60;
    },

    restoreCounts: function () {
        Object.keys(this.passCounts).forEach(playerId => {
            const btn = document.getElementById(`player-${playerId}`);
            if (btn) {
                btn.querySelector('.pass-count').textContent = this.passCounts[playerId];
                if (this.passCounts[playerId] > 0) btn.classList.add('active');
            }
        });
    },

    bindEvents: function () {
        document.querySelectorAll('#pass-network .player-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const playerId = btn.dataset.playerId;
                const teamId = btn.dataset.teamId;

                if (this.lastPlayerId) {
                    this.recordPass(this.lastPlayerId, playerId, this.lastTeamId, teamId);
                }

                this.lastPlayerId = playerId;
                this.lastTeamId = teamId;
                this.highlightButton(playerId);
            });
        });

        document.querySelector('#pass-network #opponent-btn').addEventListener('click', () => {
            const opponentTeamId = document.getElementById('opponent-btn').dataset.teamId;
            if (this.lastPlayerId && this.lastTeamId) {
                this.recordPass(this.lastPlayerId, null, this.lastTeamId, opponentTeamId, false, false);
                this.lastPlayerId = null;
                this.lastTeamId = null;
                this.highlightButton(null);
            }
        });
    },

    recordPass: function (fromPlayerId, toPlayerId, fromTeamId, toTeamId, isSuccessful = true, isPossessionRegained = false) {
        fetch("{% url 'tagging_app:save_pass_network' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCookie('csrftoken'),
            },
            body: JSON.stringify({
                match_id: this.matchId,
                from_player_id: fromPlayerId,
                to_player_id: toPlayerId,
                from_team_id: fromTeamId,
                to_team_id: toTeamId,
                minute: this.minute,
                second: this.second,
                x_start: null,
                y_start: null,
                x_end: null,
                y_end: null,
                is_successful: isSuccessful,
                is_possession_regained: isPossessionRegained
            })
        }).then(response => response.json()).then(data => {
            if (data.status === 'success') {
                document.getElementById('last-pass').textContent = `From ${fromPlayerId} â†’ To ${toPlayerId || 'Opponent Intercept'}`;
                this.updatePassCount(fromPlayerId, data.count);
                this.highlightButton(toPlayerId);
            } else {
                alert("Failed to save: " + data.message);
            }
        }).catch(error => {
            console.error("Fetch error:", error);
            alert("Failed to save due to network error.");
        });
    },

    updatePassCount: function (playerId, newCount) {
        const btn = document.getElementById(`player-${playerId}`);
        if (!btn) return;
        const countSpan = btn.querySelector('.pass-count');
        countSpan.textContent = newCount;
        this.passCounts[playerId] = newCount;
        localStorage.setItem('passCounts', JSON.stringify(this.passCounts));
    },

    highlightButton: function (playerId) {
        document.querySelectorAll('#pass-network .player-btn').forEach(btn => btn.classList.remove('active'));
        if (playerId) {
            const btn = document.getElementById(`player-${playerId}`);
            if (btn) btn.classList.add('active');
        }
    },

    getCookie: function (name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                const cookie = c.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
};

// Initialize after DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.PassNetwork.init();
});
</script>

{% load static %}

<title>Passing Network Tagging</title>

<style>
.opponent-btn.active {
  background-color: green !important;
  color: white !important;
  border-color: green !important;
}
.player-btn.active {
  outline: 3px solid #28a745;
}

/* --- Mobile Responsive Adjustments --- */
#our-players {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  gap: 10px;
}

/* Buttons & opponent button */
.player-btn, .opponent-btn {
  min-width: 70px;
  min-height: 70px;
  font-size: 10px;
  padding: 4px;
}

/* Opponent button pass count */
.opponent-btn .pass-count {
  font-size: 10px;
  padding: 1px 4px;
}

/* Player name overlay */
.player-btn span {
  font-size: 10px;
}

/* Adjust grid gap & size for very small screens */
@media (max-width: 480px) {
  #our-players {
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 6px;
  }
  .player-btn {
    min-width: 60px;
    min-height: 60px;
  }
  .player-btn span {
    font-size: 9px;
  }
  .opponent-btn {
    min-width: 120px;
    min-height: 45px;
    font-size: 11px;
    padding-right: 25px;
  }
  .opponent-btn .pass-count {
    font-size: 9px;
    padding: 1px 3px;
  }
}

</style>

<div id="pass-network">

  <!-- Players will be dynamically loaded -->
  <div id="our-players" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
    <p>Loading players...</p>
  </div>

  <!-- Opponent button -->
  <div style="margin: 12px 0; text-align: center;">
    <button class="opponent-btn" id="opponent-btn" data-team-id="{{ opponent_team.id }}"
            style="position: relative; padding-right: 30px; font-size: 12px; min-width: 140px; min-height: 50px; border-radius: 8px;">
      {{ opponent_team.name }} Ball Intercept
      <span class="pass-count" id="opponent-pass-count" 
            style="position: absolute; top: 5px; right: 8px; background: #0073e6; color: white; border-radius: 12px; padding: 2px 8px; font-size: 12px;">
        0
      </span>
    </button>
  </div>

  <p><strong>Last Pass:</strong> <span id="last-pass"></span></p>
</div>

<a href="{% url 'lineup_app:substitution_panel' match.id %}">SUB</a>

<script>
window.PassNetwork = {
    matchId: {{ match.id }},
    lastPlayerId: null,
    lastTeamId: null,
    minute: 0,
    second: 0,
    passCounts: JSON.parse(localStorage.getItem('passCounts') || '{}'),

    init: function () {
        this.restoreCounts();
        this.bindOpponentEvent();
        this.updateTimer();
        setInterval(this.updateTimer.bind(this), 1000);
        loadPlayers(); // first load
        setInterval(loadPlayers, 10000); // refresh every 10s
    },

    updateTimer: function () {
        let startTimestamp = localStorage.getItem('passNetworkStartTimestamp');
        if (!startTimestamp) {
            startTimestamp = new Date().toISOString();
            localStorage.setItem('passNetworkStartTimestamp', startTimestamp);
        }
        const start = new Date(startTimestamp);
        const now = new Date();
        const diff = Math.floor((now - start) / 1000);
        this.minute = Math.floor(diff / 60);
        this.second = diff % 60;
    },

    restoreCounts: function () {
        Object.keys(this.passCounts).forEach(playerId => {
            const btn = document.getElementById(`player-${playerId}`);
            if (btn) {
                btn.querySelector('.pass-count').textContent = this.passCounts[playerId];
                if (this.passCounts[playerId] > 0) btn.classList.add('active');
            }
        });
    },

    bindPlayerEvents: function () {
        document.querySelectorAll('#pass-network .player-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const playerId = btn.dataset.playerId;
                const teamId = btn.dataset.teamId;

                if (this.lastPlayerId) {
                    this.recordPass(this.lastPlayerId, playerId, this.lastTeamId, teamId);
                }

                this.lastPlayerId = playerId;
                this.lastTeamId = teamId;
                this.highlightButton(playerId);
            });
        });
    },

    bindOpponentEvent: function () {
        const opponentBtn = document.getElementById('opponent-btn');
        opponentBtn.addEventListener('click', () => {
            const opponentTeamId = opponentBtn.dataset.teamId;
            if (this.lastPlayerId && this.lastTeamId) {
                this.recordPass(this.lastPlayerId, null, this.lastTeamId, opponentTeamId, false, false);
                this.lastPlayerId = null;
                this.lastTeamId = null;
                this.highlightButton(null);

                // Opponent count
                if (!this.opponentPassCount) this.opponentPassCount = 0;
                this.opponentPassCount++;
                document.getElementById('opponent-pass-count').textContent = this.opponentPassCount;

                opponentBtn.classList.add('active');
                setTimeout(() => opponentBtn.classList.remove('active'), 500);
            }
        });
    },

    recordPass: function (fromPlayerId, toPlayerId, fromTeamId, toTeamId, isSuccessful = true, isPossessionRegained = false) {
        fetch("{% url 'tagging_app:save_pass_network' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCookie('csrftoken'),
            },
            body: JSON.stringify({
                match_id: this.matchId,
                from_player_id: fromPlayerId,
                to_player_id: toPlayerId,
                from_team_id: fromTeamId,
                to_team_id: toTeamId,
                minute: this.minute,
                second: this.second,
                x_start: null,
                y_start: null,
                x_end: null,
                y_end: null,
                is_successful: isSuccessful,
                is_possession_regained: isPossessionRegained
            })
        }).then(response => response.json()).then(data => {
            if (data.status === 'success') {
                document.getElementById('last-pass').textContent = `From ${fromPlayerId} â†’ To ${toPlayerId || 'Opponent Intercept'}`;
                this.updatePassCount(fromPlayerId, data.count);
                this.highlightButton(toPlayerId);
            } else {
                alert("Failed to save: " + data.message);
            }
        }).catch(error => {
            console.error("Fetch error:", error);
            alert("Failed to save due to network error.");
        });
    },

    updatePassCount: function (playerId, newCount) {
        const btn = document.getElementById(`player-${playerId}`);
        if (!btn) return;
        const countSpan = btn.querySelector('.pass-count');
        countSpan.textContent = newCount;
        this.passCounts[playerId] = newCount;
        localStorage.setItem('passCounts', JSON.stringify(this.passCounts));
    },

    highlightButton: function (playerId) {
        document.querySelectorAll('#pass-network .player-btn').forEach(btn => btn.classList.remove('active'));
        if (playerId) {
            const btn = document.getElementById(`player-${playerId}`);
            if (btn) btn.classList.add('active');
        }
    },

    getCookie: function (name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                const cookie = c.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
};

// Load players dynamically
function loadPlayers() {
  const matchId = window.PassNetwork.matchId;
  fetch(`/tagging/api_current_on_field_players/${matchId}/`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("our-players");
      container.innerHTML = "";
      data.players.forEach(p => {
        container.innerHTML += `
          <button class="player-btn"
                  id="player-${p.id}"
                  data-player-id="${p.id}"
                  data-team-id="${p.team_id || ''}"
                  style="width:90px;height:90px;border-radius:50%;border:2px solid #0073e6;
                         background-image:url('${p.photo_url || '/static/default_player.png'}');
                         background-size:cover;background-position:center;position:relative;">
            <span style="background:rgba(0,0,0,0.5);width:100%;text-align:center;
                         border-bottom-left-radius:50%;border-bottom-right-radius:50%;
                         padding:1px 2px;">${p.name}</span>
            <span class="pass-count"
                  style="position:absolute;top:-5px;right:-5px;background:#0073e6;color:white;
                         font-size:8px;padding:1px 4px;border-radius:10px;border:1px solid white;">0</span>
          </button>`;
      });
      window.PassNetwork.bindPlayerEvents(); // re-bind clicks
      window.PassNetwork.restoreCounts();    // restore pass counts
    });
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    window.PassNetwork.init();
});
</script>

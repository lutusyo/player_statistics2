{% extends 'base.html' %}
{% load static %}

{% block content %}

<title>Passing Network Tagging</title>

<style>
.team-section {
  margin-bottom: 20px;
  text-align: center;
}

.team-title {
  font-weight: bold;
  margin-bottom: 8px;
  text-transform: uppercase;
  color: #0073e6;
}

#our-players, #opponent-players {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  justify-items: center;
  padding: 5px;
}

.player-btn {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  border: 2px solid #0073e6;
  background-size: cover;
  background-position: center;
  position: relative;
  font-size: 10px;
  padding: 0;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  transition: transform 0.1s ease-in-out;
}

.player-btn.active {
  transform: scale(1.1);
  border-color: #28a745;
}

.player-btn span {
  background: rgba(0,0,0,0.5);
  width: 100%;
  text-align: center;
  border-bottom-left-radius: 50%;
  border-bottom-right-radius: 50%;
  padding: 2px 0;
  font-size: 10px;
  color: white;
  line-height: 1;
}


.player-btn span strong {
  font-size: 20px;
  color: #ffd700;
}



.player-btn .pass-count {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #0073e6;
  color: white;
  font-size: 8px;
  padding: 1px 4px;
  border-radius: 10px;
  border: 1px solid white;
}

#opponent-section .player-btn {
  border-color: #ff4d4d;
}

#opponent-section .player-btn .pass-count {
  background: #ff4d4d;
}

@media (max-width: 480px) {
  #our-players, #opponent-players {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  .player-btn {
    width: 60px;
    height: 60px;
    font-size: 9px;
  }
  .player-btn span {
    font-size: 8px;
  }
}
</style>

<div id="pass-network">
  <!-- OUR TEAM -->
  <div id="our-section" class="team-section">
    <div class="team-title">{{ our_team.name }}</div>
    <div id="our-players"><p>Loading our players...</p></div>
  </div>

  <!-- OPPONENT TEAM -->
  <div id="opponent-section" class="team-section">
    <div class="team-title">{{ opponent_team.name }}</div>
    <div id="opponent-players"><p>Loading opponent players...</p></div>
  </div>

  <div style="text-align: center; margin-top: 10px;">
    <button id="ball-out-btn" class="btn btn-warning btn-sm">
      Ball out of Play
    </button>
  </div>

  <p><strong>Last Pass:</strong> <span id="last-pass"></span></p>
</div>

<a href="{% url 'lineup_app:substitution_panel' match.id %}">SUB</a>

<script>
window.PassNetwork = {
  matchId: {{ match.id }},
  lastPlayerId: null,
  lastTeamId: null,
  opponentTeamId: {{ opponent_team.id }},
  ourTeamId: {{ our_team.id }},
  passCounts: JSON.parse(localStorage.getItem('passCounts') || '{}'),

  init: function () {
    this.loadPlayers();
    setInterval(this.loadPlayers, 10000);
  },

  loadPlayers: function () {
    fetch(`/tagging/api_current_on_field_players/${window.PassNetwork.matchId}/`)
      .then(res => res.json())
      .then(data => {
        const ourContainer = document.getElementById("our-players");
        const oppContainer = document.getElementById("opponent-players");
        ourContainer.innerHTML = "";
        oppContainer.innerHTML = "";

        const players = data.players || [];
        if (!players.length) {
          ourContainer.innerHTML = "<p style='color:red;'>No players on field</p>";
          oppContainer.innerHTML = "";
          return;
        }

        players.forEach(p => {
          const btnHTML = `
            <button class="player-btn" id="player-${p.id}"
                    data-player-id="${p.id}" data-team-id="${p.team_id}"
                    style="background-image:url('${p.photo_url || '/static/default_player.png'}');">
              <span>
                ${p.name}<br>
                <strong>${p.jersey_number}</strong>
              </span>
              <span class="pass-count">0</span>
            </button>`;
          if (p.team_id == window.PassNetwork.ourTeamId)
            ourContainer.innerHTML += btnHTML;
          else if (p.team_id == window.PassNetwork.opponentTeamId)
            oppContainer.innerHTML += btnHTML;
        });

        window.PassNetwork.bindPlayerEvents();
        window.PassNetwork.restoreCounts();
      });
  },

  bindPlayerEvents: function () {
    document.querySelectorAll('.player-btn').forEach(btn => {
      btn.onclick = () => {
        const playerId = btn.dataset.playerId;
        const teamId = btn.dataset.teamId;

        if (window.PassNetwork.lastPlayerId)
          window.PassNetwork.recordPass(window.PassNetwork.lastPlayerId, playerId, window.PassNetwork.lastTeamId, teamId);

        window.PassNetwork.lastPlayerId = playerId;
        window.PassNetwork.lastTeamId = teamId;
        window.PassNetwork.highlightButton(playerId);
      };
    });
  },

  recordPass: function (fromId, toId, fromTeam, toTeam) {
    fetch("{% url 'tagging_app:save_pass_network' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': this.getCookie('csrftoken'),
      },
      body: JSON.stringify({
        match_id: this.matchId,
        from_player_id: fromId,
        to_player_id: toId,
        from_team_id: fromTeam,
        to_team_id: toTeam
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        document.getElementById('last-pass').textContent = `From ${fromId} â†’ To ${toId}`;
        this.updatePassCount(fromId, data.count);
      }
    });
  },

  updatePassCount: function (playerId, newCount) {
    const btn = document.getElementById(`player-${playerId}`);
    if (!btn) return;
    const countSpan = btn.querySelector('.pass-count');
    countSpan.textContent = newCount;
    this.passCounts[playerId] = newCount;
    localStorage.setItem('passCounts', JSON.stringify(this.passCounts));
  },

  restoreCounts: function () {
    Object.entries(this.passCounts).forEach(([pid, count]) => {
      const btn = document.getElementById(`player-${pid}`);
      if (btn) btn.querySelector('.pass-count').textContent = count;
    });
  },

  highlightButton: function (playerId) {
    document.querySelectorAll('.player-btn').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById(`player-${playerId}`);
    if (btn) btn.classList.add('active');
  },

  getCookie: function (name) {
    let cookieValue = null;
    document.cookie.split(';').forEach(cookie => {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) cookieValue = decodeURIComponent(cookie.split('=')[1]);
    });
    return cookieValue;
  }
};

document.addEventListener('DOMContentLoaded', () => window.PassNetwork.init());
</script>

{% endblock %}

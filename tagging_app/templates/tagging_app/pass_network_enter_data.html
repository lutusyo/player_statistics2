{% extends 'base.html' %}
{% load static %}

{% block content %}

<title>Passing Network Tagging</title>

<style>
#our-players {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  justify-items: center;
  padding: 5px;
}

.player-btn {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  border: 2px solid #0073e6;
  background-size: cover;
  background-position: center;
  position: relative;
  font-size: 10px;
  padding: 0;
  display: flex;
  align-items: flex-end;
  justify-content: center;
}

.player-btn span {
  background: rgba(0,0,0,0.5);
  width: 100%;
  text-align: center;
  border-bottom-left-radius: 50%;
  border-bottom-right-radius: 50%;
  padding: 2px 0;
  font-size: 10px;
  color: white;
  line-height: 1;
}

.player-btn .pass-count {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #0073e6;
  color: white;
  font-size: 8px;
  padding: 1px 4px;
  border-radius: 10px;
  border: 1px solid white;
}

.opponent-btn {
  min-width: 120px;
  min-height: 50px;
  font-size: 12px;
  border-radius: 8px;
  position: relative;
}

.opponent-btn .pass-count {
  position: absolute;
  top: 5px;
  right: 8px;
  background: #0073e6;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 12px;
}

@media (max-width: 480px) {
  #our-players {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  .player-btn {
    width: 60px;
    height: 60px;
    font-size: 9px;
  }
  .player-btn span {
    font-size: 8px;
  }
  .player-btn .pass-count {
    font-size: 7px;
    padding: 1px 3px;
  }
  .opponent-btn {
    min-width: 100px;
    min-height: 45px;
    font-size: 10px;
    padding-right: 20px;
  }
  .opponent-btn .pass-count {
    font-size: 8px;
    padding: 1px 3px;
  }
}
</style>

<div id="pass-network">
  <div id="our-players"><p>Loading players...</p></div>

  <div style="margin: 12px 0; text-align: center;">
    <button class="opponent-btn" id="opponent-btn" data-team-id="{{ opponent_team.id }}">
      {{ opponent_team.name }}
      <span class="pass-count" id="opponent-pass-count">0</span>
    </button>
  </div>

  <div style="text-align: center; margin-top: 10px;">
    <button id="ball-out-btn" class="btn btn-warning" style="font-size: 12;">
      Ball out of Play
    </button>
  </div>

  <p><strong>Last Pass:</strong> <span id="last-pass"></span></p>
</div>

<a href="{% url 'lineup_app:substitution_panel' match.id %}">SUB</a>

<script>
window.PassNetwork = {
    matchId: {{ match.id }},
    lastPlayerId: null,
    lastTeamId: null,
    lastOpponentTeamId: null,
    minute: 0,
    second: 0,
    passCounts: JSON.parse(localStorage.getItem('passCounts') || '{}'),
    throwInMode: false,
    currentThrowIn: null,

    init: function () {
        this.restoreCounts();
        this.bindOpponentEvent();
        this.bindBallOutEvent();
        this.updateTimer();
        setInterval(this.updateTimer.bind(this), 1000);
        loadPlayers();
        setInterval(loadPlayers, 10000);
    },

    updateTimer: function () {
        let startTimestamp = localStorage.getItem('passNetworkStartTimestamp');
        if (!startTimestamp) {
            startTimestamp = new Date().toISOString();
            localStorage.setItem('passNetworkStartTimestamp', startTimestamp);
        }
        const start = new Date(startTimestamp);
        const now = new Date();
        const diff = Math.floor((now - start) / 1000);
        this.minute = Math.floor(diff / 60);
        this.second = diff % 60;
    },

    restoreCounts: function () {
        Object.keys(this.passCounts).forEach(playerId => {
            const btn = document.getElementById(`player-${playerId}`);
            if (btn) {
                btn.querySelector('.pass-count').textContent = this.passCounts[playerId];
                if (this.passCounts[playerId] > 0) btn.classList.add('active');
            }
        });
    },

    bindPlayerEvents: function () {
        document.querySelectorAll('#pass-network .player-btn').forEach(btn => {
            btn.onclick = () => {
                const playerId = btn.dataset.playerId;
                const teamId = btn.dataset.teamId;

                // HANDLE THROW-IN MODE
                if (this.throwInMode && this.currentThrowIn) {
                    const { teamId: throwInTeamId, ballOutById, ballOutTeamId } = this.currentThrowIn;
                    this.recordBallOut(ballOutById, ballOutTeamId, throwInTeamId, playerId);
                    this.throwInMode = false;
                    this.currentThrowIn = null;
                    document.getElementById('our-players').style.border = 'none';
                    this.resetAfterBallOut();
                    return;
                }

                // NORMAL PASS
                if (this.lastPlayerId) {
                    this.recordPass(this.lastPlayerId, playerId, this.lastTeamId, teamId);
                }

                this.lastPlayerId = playerId;
                this.lastTeamId = teamId;
                this.lastOpponentTeamId = null;
                this.highlightButton(playerId);
            };
        });
    },

    bindOpponentEvent: function () {
        const opponentBtn = document.getElementById('opponent-btn');
        opponentBtn.addEventListener('click', () => {
            const opponentTeamId = opponentBtn.dataset.teamId;
            if (this.lastPlayerId && this.lastTeamId) {
                this.recordPass(this.lastPlayerId, null, this.lastTeamId, opponentTeamId, false, false);
            }
            this.lastOpponentTeamId = opponentTeamId;
            this.lastPlayerId = null;
            this.lastTeamId = null;
            this.highlightButton(null);

            if (!this.opponentPassCount) this.opponentPassCount = 0;
            this.opponentPassCount++;
            document.getElementById('opponent-pass-count').textContent = this.opponentPassCount;

            opponentBtn.classList.add('active');
            setTimeout(() => opponentBtn.classList.remove('active'), 500);
        });
    },

    bindBallOutEvent: function () {
        const btn = document.getElementById('ball-out-btn');
        btn.addEventListener('click', () => {
            const opponentTeamId = {{ opponent_team.id }};
            const ourTeamId = {{ our_team.id }};
            let ballOutById = null;
            let ballOutTeamId = null;

            if (this.lastPlayerId && this.lastTeamId) {
                ballOutById = this.lastPlayerId;
                ballOutTeamId = this.lastTeamId;
            } else if (this.lastOpponentTeamId) {
                ballOutTeamId = this.lastOpponentTeamId;
            } else {
                alert("Select a player or opponent first before marking Ball Out!");
                return;
            }

            const isOurTeam = ballOutTeamId == ourTeamId;
            const throwInTeamId = isOurTeam ? opponentTeamId : ourTeamId;

            if (isOurTeam) {
                alert("Ball out by our team — opponent will take the throw-in.");
                this.recordBallOut(ballOutById, ballOutTeamId, throwInTeamId, null);
                this.resetAfterBallOut();
            } else {
                this.throwInMode = true;
                this.currentThrowIn = { teamId: throwInTeamId, ballOutById, ballOutTeamId };
                document.getElementById('our-players').style.border = '2px dashed red';
                alert("Select the player who will take the throw-in by clicking their picture.");
            }
        });
    },

    resetAfterBallOut: function() {
        this.lastPlayerId = null;
        this.lastTeamId = null;
        this.lastOpponentTeamId = null;
        this.highlightButton(null);
    },

    recordPass: function (fromPlayerId, toPlayerId, fromTeamId, toTeamId, isSuccessful = true, isPossessionRegained = false) {
        fetch("{% url 'tagging_app:save_pass_network' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCookie('csrftoken'),
            },
            body: JSON.stringify({
                match_id: this.matchId,
                from_player_id: fromPlayerId,
                to_player_id: toPlayerId,
                from_team_id: fromTeamId,
                to_team_id: toTeamId,
                minute: this.minute,
                second: this.second,
                is_successful: isSuccessful,
                is_possession_regained: isPossessionRegained
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('last-pass').textContent =
                  `From ${fromPlayerId} → To ${toPlayerId || 'Opponent Intercept'}`;
                this.updatePassCount(fromPlayerId, data.count);
            } else alert("Failed to save: " + data.message);
        })
        .catch(err => console.error(err));
    },

    recordBallOut: function (ballOutById, ballOutTeamId, throwInTeamId, throwInPlayerId) {
        fetch("{% url 'tagging_app:save_pass_network' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCookie('csrftoken'),
            },
            body: JSON.stringify({
                match_id: this.matchId,
                from_player_id: ballOutById,
                from_team_id: ballOutTeamId,
                to_team_id: throwInTeamId,
                minute: this.minute,
                second: this.second,
                is_successful: false,
                is_ball_out: true,
                ball_out_by: ballOutById,
                throw_in_team: throwInTeamId,
                throw_in_player: throwInPlayerId
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('last-pass').textContent =
                  `Ball Out by ${ballOutTeamId == {{ our_team.id }} ? 'Our Team' : 'Opponent'}, Throw-in → Team ${throwInTeamId}`;
            } else alert("Error saving ball-out: " + data.message);
        })
        .catch(err => console.error(err));
    },

    updatePassCount: function (playerId, newCount) {
        const btn = document.getElementById(`player-${playerId}`);
        if (!btn) return;
        const countSpan = btn.querySelector('.pass-count');
        countSpan.textContent = newCount;
        this.passCounts[playerId] = newCount;
        localStorage.setItem('passCounts', JSON.stringify(this.passCounts));
    },

    highlightButton: function (playerId) {
        document.querySelectorAll('#pass-network .player-btn').forEach(btn => btn.classList.remove('active'));
        if (playerId) {
            const btn = document.getElementById(`player-${playerId}`);
            if (btn) btn.classList.add('active');
        }
    },

    getCookie: function (name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                const cookie = c.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
};

function loadPlayers() {
  const matchId = window.PassNetwork.matchId;
  fetch(`/tagging/api_current_on_field_players/${matchId}/`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("our-players");
      container.innerHTML = "";
      if (!data.players || !data.players.length) {
        container.innerHTML = "<p style='color:red;'>No players currently on the field</p>";
        return;
      }
      data.players.forEach(p => {
        container.innerHTML += `
          <button class="player-btn" id="player-${p.id}"
                  data-player-id="${p.id}" data-team-id="${p.team_id || ''}"
                  style="background-image:url('${p.photo_url || '/static/default_player.png'}');">
            <span>${p.name}</span>
            <span class="pass-count">0</span>
          </button>`;
      });
      window.PassNetwork.bindPlayerEvents();
      window.PassNetwork.restoreCounts();
    });
}

document.addEventListener('DOMContentLoaded', () => {
    window.PassNetwork.init();
});
</script>

{% endblock %}

{% load static %}

{% load static %}

<title>Passing Network Tagging</title>
<style>
.opponent-btn.active {
  background-color: green !important;
  color: white !important;
  border-color: green !important;
}
</style>


<div id="pass-network">

  <!-- Opponent button at the top -->
<div style="margin-bottom: 12px; text-align: center;">
    <button class="opponent-btn" id="opponent-btn" data-team-id="{{ opponent_team.id }}"
      style="position: relative; padding-right: 30px; font-size: 12px; min-width: 140px; min-height: 50px; border-radius: 8px;">
        {{ opponent_team.name }} Ball Intercept
        <span class="pass-count" id="opponent-pass-count" 
          style="position: absolute; top: 5px; right: 8px; background: #0073e6; color: white; border-radius: 12px; padding: 2px 8px; font-size: 12px;">
          0
        </span>
    </button>
</div>


  <!-- Players buttons in 4 columns grid -->
  <div id="our-players" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
    {% for p in our_players %}
        <button class="player-btn"
                id="player-{{ p.player.id }}"
                data-player-id="{{ p.player.id }}"
                data-team-id="{{ our_team.id }}"
                style="
                    width: 100px;
                    height: 10px;
                    border-radius: 50%;
                    border: 2px solid #0073e6;
                    background-image: url('{% if p.player.photo %}{{ p.player.photo.url }}{% else %}{% static 'default_player.png' %}{% endif %}');
                    background-size: cover;
                    background-position: center;
                    position: relative;
                    display: flex;
                    align-items: flex-end;
                    justify-content: center;
                    font-size: 10px;
                    font-weight: bold;
                    color: white;
                    text-shadow: 0 0 3px rgba(0,0,0,0.8);
                ">
            <span style="
                background: rgba(0,0,0,0.4);
                width: 100%;
                text-align: center;
                border-bottom-left-radius: 50%;
                border-bottom-right-radius: 50%;
                padding: 2px 0;
            ">
                {{ p.player.name }}
            </span>

            <span class="pass-count" style="
                position: absolute;
                top: -6px;
                right: -6px;
                background: #0073e6;
                color: white;
                font-size: 10px;
                padding: 2px 5px;
                border-radius: 10px;
                border: 1px solid white;
            ">0</span>
        </button>


    {% endfor %}
  </div>

  <p><strong>Last Pass:</strong> <span id="last-pass"></span></p>
</div>



<script>
window.PassNetwork = {
    matchId: {{ match.id }},
    lastPlayerId: null,
    lastTeamId: null,
    minute: 0,
    second: 0,
    passCounts: JSON.parse(localStorage.getItem('passCounts') || '{}'),

    init: function () {
        this.restoreCounts();
        this.bindEvents();
        this.updateTimer();
        setInterval(this.updateTimer.bind(this), 1000);
    },

    updateTimer: function () {
        let startTimestamp = localStorage.getItem('passNetworkStartTimestamp');
        if (!startTimestamp) {
            startTimestamp = new Date().toISOString();
            localStorage.setItem('passNetworkStartTimestamp', startTimestamp);
        }
        const start = new Date(startTimestamp);
        const now = new Date();
        const diff = Math.floor((now - start) / 1000);
        this.minute = Math.floor(diff / 60);
        this.second = diff % 60;
    },

    restoreCounts: function () {
        Object.keys(this.passCounts).forEach(playerId => {
            const btn = document.getElementById(`player-${playerId}`);
            if (btn) {
                btn.querySelector('.pass-count').textContent = this.passCounts[playerId];
                if (this.passCounts[playerId] > 0) btn.classList.add('active');
            }
        });
    },

    bindEvents: function () {
        document.querySelectorAll('#pass-network .player-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const playerId = btn.dataset.playerId;
                const teamId = btn.dataset.teamId;

                if (this.lastPlayerId) {
                    this.recordPass(this.lastPlayerId, playerId, this.lastTeamId, teamId);
                }

                this.lastPlayerId = playerId;
                this.lastTeamId = teamId;
                this.highlightButton(playerId);
            });
        });
        document.querySelector('#pass-network #opponent-btn').addEventListener('click', () => {
            const opponentTeamId = document.getElementById('opponent-btn').dataset.teamId;
            if (this.lastPlayerId && this.lastTeamId) {
                this.recordPass(this.lastPlayerId, null, this.lastTeamId, opponentTeamId, false, false);
                this.lastPlayerId = null;
                this.lastTeamId = null;
                this.highlightButton(null);

                // Increase opponent pass count locally and update UI
                if (!this.opponentPassCount) this.opponentPassCount = 0;
                this.opponentPassCount++;
                document.getElementById('opponent-pass-count').textContent = this.opponentPassCount;

                // Toggle active class for opponent button
                const opponentBtn = document.getElementById('opponent-btn');
                opponentBtn.classList.add('active');
                setTimeout(() => opponentBtn.classList.remove('active'), 500); // reset color after 0.5s
            }
        });
        
    },

    recordPass: function (fromPlayerId, toPlayerId, fromTeamId, toTeamId, isSuccessful = true, isPossessionRegained = false) {
        fetch("{% url 'tagging_app:save_pass_network' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': this.getCookie('csrftoken'),
            },
            body: JSON.stringify({
                match_id: this.matchId,
                from_player_id: fromPlayerId,
                to_player_id: toPlayerId,
                from_team_id: fromTeamId,
                to_team_id: toTeamId,
                minute: this.minute,
                second: this.second,
                x_start: null,
                y_start: null,
                x_end: null,
                y_end: null,
                is_successful: isSuccessful,
                is_possession_regained: isPossessionRegained
            })
        }).then(response => response.json()).then(data => {
            if (data.status === 'success') {
                document.getElementById('last-pass').textContent = `From ${fromPlayerId} â†’ To ${toPlayerId || 'Opponent Intercept'}`;
                this.updatePassCount(fromPlayerId, data.count);
                this.highlightButton(toPlayerId);
            } else {
                alert("Failed to save: " + data.message);
            }
        }).catch(error => {
            console.error("Fetch error:", error);
            alert("Failed to save due to network error.");
        });
    },

    updatePassCount: function (playerId, newCount) {
        const btn = document.getElementById(`player-${playerId}`);
        if (!btn) return;
        const countSpan = btn.querySelector('.pass-count');
        countSpan.textContent = newCount;
        this.passCounts[playerId] = newCount;
        localStorage.setItem('passCounts', JSON.stringify(this.passCounts));
    },

    highlightButton: function (playerId) {
        document.querySelectorAll('#pass-network .player-btn').forEach(btn => btn.classList.remove('active'));
        if (playerId) {
            const btn = document.getElementById(`player-${playerId}`);
            if (btn) btn.classList.add('active');
        }
    },

    getCookie: function (name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                const cookie = c.trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
};

// Initialize after DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.PassNetwork.init();
});

function loadPlayers() {
  fetch(`/tagging/current_players/${matchId}/`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("our-players");
      container.innerHTML = "";
      data.players.forEach(p => {
        container.innerHTML += `
          <button class="player-btn" data-player-id="${p.id}"
            style="width:90px;height:90px;border-radius:50%;border:2px solid #0073e6;
                   background-image:url('${p.photo_url || '/static/default_player.png'}');
                   background-size:cover;background-position:center;position:relative;">
              <span style="background:rgba(0,0,0,0.5);width:100%;text-align:center;
                           border-bottom-left-radius:50%;border-bottom-right-radius:50%;
                           padding:1px 2px;">${p.name}</span>
              <span class="count-badge"
                    style="position:absolute;top:-5px;right:-5px;background:#0073e6;color:white;
                           font-size:8px;padding:1px 4px;border-radius:10px;border:1px solid white;">0</span>
          </button>`;
      });
    });
}

// Refresh every 10s or after substitution is finalized
setInterval(loadPlayers, 10000);

</script>

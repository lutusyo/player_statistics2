{% load static %}
{% load custom_filters %}

{% block content %}

<div id="attempt-to-goal" class="tag-panel" style="padding: 10px;">

  <!-- Outcome panel: initially visible -->
  <div id="outcome-panel" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px;">
    {% for value, label in outcomes %}
      {% with count=total_outcome_counts|get_item:value|stringformat:"s"|default:0 %}
        <button class="outcome-btn" data-outcome="{{ value }}"
          style="display: flex; flex-direction: column; align-items: center; justify-content: center;
                 padding: 12px; background-color: #e6f2ff; border: 2px solid #0073e6; cursor: pointer;
                 border-radius: 10px; font-size: 13px; font-weight: 600; transition: all 0.2s ease-in-out; color: #0073e6;">
          {{ label }}
          <span class="count-badge">{{ count }}</span>
        </button>
      {% endwith %}
    {% endfor %}
  </div>

  <!-- Players list: initially hidden -->
  <div id="our-players" style="
    display: none;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-top: 12px;
  ">
    <!-- Buttons loaded dynamically via JS -->
  </div>

  <!-- Delivery panel: initially hidden -->
  <div id="delivery-panel" style="display: none; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px;">
    {% for value, label in delivery_types %}
      <button class="delivery-btn" data-delivery-type="{{ value }}"
        style="display: flex; flex-direction: column; align-items: center; justify-content: center;
               padding: 12px; background-color: #e6f2ff; border: 2px solid #0073e6; cursor: pointer;
               border-radius: 10px; font-size: 13px; font-weight: 600; transition: all 0.2s ease-in-out; color: #0073e6;">
        {{ label }}
      </button>
    {% endfor %}
  </div>

</div>

<script>
let timer = 0;
let interval = null;
let isPaused = false;
let selectedPlayer = null, selectedOutcome = null, selectedDeliveryType = null;
const matchId = {{ match.id }};

// Format seconds → MM:SS
function formatTime(seconds) {
  let m = String(Math.floor(seconds / 60)).padStart(2, '0');
  let s = String(seconds % 60).padStart(2, '0');
  return `${m}:${s}`;
}

function updateTimerDisplay() {
  document.getElementById('timer-display')?.innerText && 
    (document.getElementById('timer-display').innerText = formatTime(timer));
  sessionStorage.setItem('tagging-timer', timer);
}

function startTimer() {
  interval = setInterval(() => {
    if (!isPaused) {
      timer++;
      updateTimerDisplay();
    }
  }, 1000);
}

function clearSelected(selector) {
  document.querySelectorAll(selector).forEach(btn => btn.classList.remove('selected'));
}

// Select player function
function selectPlayer(btn, playerId) {
  selectedPlayer = playerId;

  document.getElementById('outcome-panel').style.display = 'none';
  document.getElementById('our-players').style.display = 'none';
  document.getElementById('delivery-panel').style.display = 'grid';

  clearSelected('.player-btn');
  clearSelected('.delivery-btn');

  btn.classList.add('selected');
}

// Fetch currently on-field players
function refreshOnFieldPlayers() {
    fetch(`/tagging/api_current_on_field_players/${matchId}/`)
    .then(res => res.json())
    .then(data => {
        const container = document.getElementById('our-players');
        container.innerHTML = ''; // clear old buttons
        data.players.forEach(p => {
            const btn = document.createElement('button');
            btn.className = 'player-btn';
            btn.dataset.playerId = p.id;
            btn.style.width = '90px';
            btn.style.height = '90px';
            btn.style.borderRadius = '50%';
            btn.style.border = '2px solid #0073e6';
            btn.style.backgroundImage = `url('${p.photo_url || "{% static 'default_player.png' %}"}')`;
            btn.style.backgroundSize = 'cover';
            btn.style.backgroundPosition = 'center';
            btn.style.position = 'relative';
            btn.style.display = 'flex';
            btn.style.alignItems = 'flex-end';
            btn.style.justifyContent = 'center';
            btn.style.fontSize = '8px';
            btn.style.fontWeight = 'bold';
            btn.style.color = 'white';
            btn.style.textShadow = '0 0 2px rgba(0, 0, 0, 0.8)';

            const nameSpan = document.createElement('span');
            nameSpan.style.background = 'rgba(0, 0, 0, 0.5)';
            nameSpan.style.width = '100%';
            nameSpan.style.textAlign = 'center';
            nameSpan.style.borderBottomLeftRadius = '50%';
            nameSpan.style.borderBottomRightRadius = '50%';
            nameSpan.style.padding = '1px 2px';
            nameSpan.textContent = p.name.length > 8 ? p.name.substring(0,8) : p.name;

            btn.appendChild(nameSpan);

            container.appendChild(btn);
        });
    });
}

// Update live event log
function updateEventLog() {
    fetch(`/tagging/live_state/${matchId}/`)
      .then(res => res.json())
      .then(data => {
          const log = document.getElementById('event-log');
          log.innerHTML = '';
          data.events.forEach(ev => {
              log.innerHTML += `<div><b>${ev.player_name}</b> - ${ev.outcome} - ${ev.delivery_type} at ${String(ev.minute).padStart(2,'0')}:${String(ev.second).padStart(2,'0')}</div>`;
          });
      });
}

// ✅ NEW: Refresh outcome counts
function refreshOutcomeCounts() {
    fetch(`/tagging/match/${matchId}/api/outcome-counts/`)
      .then(res => res.json())
      .then(data => {
          document.querySelectorAll('.outcome-btn').forEach(btn => {
              const outcome = btn.dataset.outcome;
              const badge = btn.querySelector('.count-badge');
              badge.textContent = data[outcome] || 0;
          });
      });
}

// Save attempt
function saveAttempt(outcome, playerId, deliveryType) {
    const now = new Date();
    const data = {
        match_id: matchId,
        player_id: playerId,
        outcome: outcome,
        delivery_type: deliveryType,
        minute: Math.floor(timer / 60),
        second: timer % 60,
        timestamp: now.toISOString()
    };

    fetch("{% url 'tagging_app:save_attempt_to_goal' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(json => {
        if (json.status === 'ok') {
            updateEventLog();
            refreshOnFieldPlayers();
            refreshOutcomeCounts();   // ✅ update counts live

            selectedPlayer = selectedOutcome = selectedDeliveryType = null;

            document.getElementById('outcome-panel').style.display = 'grid';
            document.getElementById('our-players').style.display = 'none';
            document.getElementById('delivery-panel').style.display = 'none';
        } else {
            alert(json.message);
        }
    });
}

// Initialize page
window.onload = function () {
    timer = parseInt(sessionStorage.getItem('tagging-timer')) || 0;
    updateTimerDisplay();
    startTimer();

    refreshOnFieldPlayers();
    updateEventLog();
    refreshOutcomeCounts(); // also refresh on load
};

// Outcome click → show players
document.getElementById('outcome-panel').addEventListener('click', function(e) {
  if (e.target.classList.contains('outcome-btn') || e.target.closest('.outcome-btn')) {
    const btn = e.target.closest('.outcome-btn');
    selectedOutcome = btn.dataset.outcome;

    document.getElementById('outcome-panel').style.display = 'none';
    document.getElementById('our-players').style.display = 'grid';
    document.getElementById('delivery-panel').style.display = 'none';

    clearSelected('.outcome-btn');
    clearSelected('.player-btn');
    clearSelected('.delivery-btn');

    btn.classList.add('selected');
  }
});

// Player click → show delivery options (event delegation)
document.getElementById('our-players').addEventListener('click', function(e) {
  if (e.target.classList.contains('player-btn') || e.target.closest('.player-btn')) {
    const btn = e.target.closest('.player-btn');
    selectPlayer(btn, btn.dataset.playerId);
  }
});

// Delivery click → save attempt (event delegation)
document.getElementById('delivery-panel').addEventListener('click', function(e) {
  if (e.target.classList.contains('delivery-btn') || e.target.closest('.delivery-btn')) {
    const btn = e.target.closest('.delivery-btn');
    selectedDeliveryType = btn.dataset.deliveryType;
    if (selectedPlayer && selectedOutcome && selectedDeliveryType) {
        saveAttempt(selectedOutcome, selectedPlayer, selectedDeliveryType);
    }
  }
});
</script>

{% endblock %}

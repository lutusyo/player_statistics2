{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<style>
  .player-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    width: 80px;
    height: 100px;
    background-size: cover;
    background-position: center;
    border: 2px solid #ccc;
    border-radius: 8px;
    padding: 4px;
    font-size: 12px;
    color: #fff;
    position: relative;
    text-shadow: 1px 1px 2px #000;
  }

  .player-btn span {
    background-color: rgba(0,0,0,0.5);
    padding: 2px 4px;
    border-radius: 4px;
    margin-top: auto;
  }

  .player-btn.selected {
    border-color: #007bff;
  }
</style>


<form method="get">
  <select name="team_id" onchange="this.form.submit()">
    <option value="{{ match.home_team.id }}" {% if active_team.id == match.home_team.id %}selected{% endif %}>
      {{ match.home_team.name }}
    </option>
    <option value="{{ match.away_team.id }}" {% if active_team.id == match.away_team.id %}selected{% endif %}>
      {{ match.away_team.name }}
    </option>
  </select>
</form>


<div id="attempt-to-goal" class="tag-panel responsive-panel">


  <!-- Outcome Panel -->
  <div id="outcome-panel" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px;">
    {% for value, label in outcomes %}
      {% with count=total_outcome_counts|get_item:value|stringformat:"s"|default:0 %}
        <button class="outcome-btn" data-outcome="{{ value }}">
          {{ label }}
          <span class="count-badge">{{ count }}</span>
        </button>
      {% endwith %}
    {% endfor %}
  </div>

  <!-- On-field Players -->
  <div id="our-players" style="display: none; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 12px;"></div>

  <!-- body part -->
  <div id="bodypart-panel" style="display: none; grid-template-columns: repeat(4,1fr); gap: 10px;">
    {% for value, label in body_parts %}
      <button class="location-btn" data-body-part="{{ value }}">{{ label }}</button>
    {% endfor %}
  </div>

  <!-- location -->
  <div id="location-panel" style="display: none; grid-template-columns: repeat(3,1fr); gap: 10px;">
    {% for value, label in locations %}
      <button class="location-btn" data-location="{{ value }}">{{ label }}</button>
    {% endfor %}
  </div>

  <!-- Delivery type -->
  <div id="delivery-panel" style="display: none; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px;">
    {% for value, label in delivery_types %}
      <button class="delivery-btn" data-delivery-type="{{ value }}">{{ label }}</button>
    {% endfor %}
  </div>

  <!-- Assist Selection -->
  <div id="assist-panel" style="display: none; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px;"></div>

  <!-- Pre-Assist Selection -->
  <div id="preassist-panel" style="display: none; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 12px;"></div>

</div>



<a href="{% url 'lineup_app:substitution_panel' match.id %}">SUB</a>

<script>
let timer = 0;
let interval = null;
let isPaused = false;
let selectedPlayer = null, selectedOutcome = null, selectedBodyPart = null, selectedLocation = null, selectedDeliveryType = null, selectedAssistPlayer = null, selectedPreAssistPlayer = null;
const matchId = {{ match.id }};

function formatTime(sec) {
  const m = String(Math.floor(sec / 60)).padStart(2, '0');
  const s = String(sec % 60).padStart(2, '0');
  return `${m}:${s}`;
}
function updateTimerDisplay() {
  const el = document.getElementById('timer-display');
  if (el) el.innerText = formatTime(timer);
  sessionStorage.setItem('tagging-timer', timer);
}
function startTimer() {
  interval = setInterval(() => { if (!isPaused) { timer++; updateTimerDisplay(); } }, 1000);
}
function clearSelected(selector) {
  document.querySelectorAll(selector).forEach(b => b.classList.remove('selected'));
}

function selectPlayer(btn, playerId) {
  selectedPlayer = playerId;
  document.getElementById('outcome-panel').style.display = 'none';
  document.getElementById('our-players').style.display = 'none';

  document.getElementById('bodypart-panel').style.display = 'grid';
  document.getElementById('location-panel').style.display = 'none';
  document.getElementById('delivery-panel').style.display = 'none';
  document.getElementById('assist-panel').style.display = 'none';
  document.getElementById('preassist-panel').style.display = 'none';

  clearSelected('.player-btn');
  clearSelected('.delivery-btn');
  btn.classList.add('selected');
}





document.getElementById('bodypart-panel').addEventListener('click', e => {
  const btn = e.target.closest('.location-btn');
  if (!btn) return;
  selectedBodyPart = btn.dataset.bodyPart;

  // Move to location selection
  document.getElementById('bodypart-panel').style.display = 'none';
  document.getElementById('location-panel').style.display = 'grid';
  document.getElementById('delivery-panel').style.display = 'none';
  document.getElementById('assist-panel').style.display = 'none';
  document.getElementById('preassist-panel').style.display = 'none';
});



document.getElementById('location-panel').addEventListener('click', e => {
  const btn = e.target.closest('.location-btn');
  if (!btn) return;
  selectedLocation = btn.dataset.location;

  // Hide location, show delivery
  document.getElementById('location-panel').style.display = 'none';
  document.getElementById('delivery-panel').style.display = 'grid';
});



function makePlayerButton(p) {
  const btn = document.createElement('button');
  btn.className = 'player-btn';
  btn.dataset.playerId = p.id;
  btn.style.backgroundImage = `url('${p.photo_url || "{% static 'default_player.png' %}"}')`;
  const span = document.createElement('span');
  span.textContent = p.name.length > 8 ? p.name.substring(0, 8) : p.name;
  btn.appendChild(span);
  return btn;
}

function refreshOnFieldPlayers() {
  fetch(`/tagging/api_current_on_field_players/${matchId}/`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('our-players');
      container.innerHTML = '';
      data.players.forEach(p => container.appendChild(makePlayerButton(p)));
    });
}

function refreshAssistPlayers() {
  fetch(`/tagging/api_current_on_field_players/${matchId}/`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('assist-panel');
      container.innerHTML = '';
      data.players
        .filter(p => p.id != selectedPlayer)
        .forEach(p => {
          const btn = makePlayerButton(p);
          btn.classList.add('assist-btn');
          container.appendChild(btn);
        });

      const skipBtn = document.createElement('button');
      skipBtn.className = 'outcome-btn';
      skipBtn.textContent = 'No Assist';
      skipBtn.onclick = () => {
        selectedAssistPlayer = null;
        document.getElementById('assist-panel').style.display = 'none';
        saveAttempt(selectedOutcome, selectedPlayer, selectedBodyPart, selectedLocation, selectedDeliveryType, selectedAssistPlayer);
      };
      container.appendChild(skipBtn);
    });
}


function refreshPreAssistPlayers() {
  fetch(`/tagging/api_current_on_field_players/${matchId}/`)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('preassist-panel');
      container.innerHTML = '';
      data.players
        .filter(p => p.id != selectedPlayer && p.id != selectedAssistPlayer)
        .forEach(p => {
          const btn = makePlayerButton(p);
          btn.classList.add('preassist-btn');
          container.appendChild(btn);
        });

      const skipBtn = document.createElement('button');
      skipBtn.className = 'outcome-btn';
      skipBtn.textContent = 'No Pre-Assist';
      skipBtn.onclick = () => {
        selectedPreAssistPlayer = null;
        document.getElementById('preassist-panel').style.display = 'none';
        saveAttempt(
          selectedOutcome,
          selectedPlayer,
          selectedBodyPart,
          selectedLocation,
          selectedDeliveryType,
          selectedAssistPlayer,
          selectedPreAssistPlayer
        );
      };
      container.appendChild(skipBtn);
    });
}




function updateEventLog() {
  fetch(`/tagging/live_state/${matchId}/`)
    .then(res => res.json())
    .then(data => {
      const log = document.getElementById('event-log');
      log.innerHTML = '';
      data.events.forEach(ev => {
        log.innerHTML += `<div><b>${ev.player_name}</b> - ${ev.outcome} - ${ev.delivery_type} at ${String(ev.minute).padStart(2,'0')}:${String(ev.second).padStart(2,'0')}</div>`;
      });
    });
}

function refreshOutcomeCounts() {
  fetch(`/tagging/match/${matchId}/api/outcome-counts/`)
    .then(res => res.json())
    .then(data => {
      document.querySelectorAll('.outcome-btn').forEach(btn => {
        const badge = btn.querySelector('.count-badge');
        badge.textContent = data[btn.dataset.outcome] || 0;
      });
    });
}

function saveAttempt(outcome, playerId, bodyPart, locationTag, deliveryType, assistPlayerId = null, preAssistPlayerId = null) {
  if (!outcome || !playerId || !bodyPart || !locationTag || !deliveryType) {
    console.error('Missing data, cannot save attempt');
    return;
  }


  const payload = {
    match_id: matchId,
    player_id: playerId,
    team_id: {{ active_team.id }},
    outcome,
    body_part: selectedBodyPart,
    location_tag: selectedLocation,
    delivery_type: deliveryType,
    assist_by_id: assistPlayerId,
    pre_assist_by_id: preAssistPlayerId,
    minute: Math.floor(timer / 60),
    second: timer % 60,
    timestamp: new Date().toISOString(),
    is_own_goal: selectedOutcome === "Own Goal",
    own_goal_for_id: {{ opponent_team.id|default:"null" }}

  };

  fetch("{% url 'tagging_app:save_attempt_to_goal' %}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(json => {
    if (json.status === 'ok') {
      updateEventLog();
      refreshOnFieldPlayers();
      refreshOutcomeCounts();
      selectedPlayer = selectedOutcome = selectedDeliveryType = selectedAssistPlayer = selectedBodyPart = selectedLocation = selectedPreAssistPlayer = null;
      document.getElementById('outcome-panel').style.display = 'grid';
      document.getElementById('our-players').style.display = 'none';
      document.getElementById('bodypart-panel').style.display = 'none';
      document.getElementById('location-panel').style.display = 'none';
      document.getElementById('delivery-panel').style.display = 'none';
      document.getElementById('assist-panel').style.display = 'none';
      document.getElementById('preassist-panel').style.display = 'none';
    } else {
      alert(json.message);
    }
  });
}


window.onload = () => {
  timer = parseInt(sessionStorage.getItem('tagging-timer')) || 0;
  updateTimerDisplay();
  startTimer();
  refreshOnFieldPlayers();
  updateEventLog();
  refreshOutcomeCounts();
};

document.getElementById('outcome-panel').addEventListener('click', e => {
  const btn = e.target.closest('.outcome-btn');
  if (!btn) return;
  selectedOutcome = btn.dataset.outcome;
  document.getElementById('outcome-panel').style.display = 'none';
  document.getElementById('our-players').style.display = 'grid';
  document.getElementById('delivery-panel').style.display = 'none';
  clearSelected('.outcome-btn');
  clearSelected('.player-btn');
  clearSelected('.delivery-btn');
  btn.classList.add('selected');
});

document.getElementById('our-players').addEventListener('click', e => {
  const btn = e.target.closest('.player-btn');
  if (btn) selectPlayer(btn, btn.dataset.playerId);
});

document.getElementById('delivery-panel').addEventListener('click', e => {
  const btn = e.target.closest('.delivery-btn');
  if (!btn) return;
  selectedDeliveryType = btn.dataset.deliveryType;
  if (selectedPlayer && selectedOutcome && selectedDeliveryType) {
    document.getElementById('delivery-panel').style.display = 'none';
    document.getElementById('assist-panel').style.display = 'grid';
    clearSelected('.delivery-btn');
    clearSelected('.assist-btn');
    btn.classList.add('selected');
    refreshAssistPlayers();
  }
});

document.getElementById('assist-panel').addEventListener('click', e => {
  const btn = e.target.closest('.assist-btn');
  if (!btn) return;
  selectedAssistPlayer = btn.dataset.playerId;
  if (selectedPlayer && selectedOutcome && selectedDeliveryType) {
    // Hide assist panel, show pre-assist panel
    document.getElementById('assist-panel').style.display = 'none';
    document.getElementById('preassist-panel').style.display = 'grid';
    refreshPreAssistPlayers();
  }
});


document.getElementById('preassist-panel').addEventListener('click', e => {
  const btn = e.target.closest('.preassist-btn');
  if (!btn) return;
  selectedPreAssistPlayer = btn.dataset.playerId;
  if (selectedPlayer && selectedOutcome && selectedDeliveryType) {
    saveAttempt(
      selectedOutcome,
      selectedPlayer,
      selectedBodyPart,
      selectedLocation,
      selectedDeliveryType,
      selectedAssistPlayer,
      selectedPreAssistPlayer
    );
  }
});


</script>
{% endblock %}

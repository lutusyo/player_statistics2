{% load static %}
{% load custom_filters %}


{% block content %}
<style>
  .tag-panel {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  .timer-controls button {
    margin-right: 10px;
  }
  .event-log {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 10px;
    margin-top: 15px;
  }
  .count-badge {
    background-color: #007bff;
    color: white;
    border-radius: 10px;
    padding: 2px 8px;
    font-size: 0.75em;
    margin-left: 5px;
  }
  .selected {
    background-color: #28a745 !important;
    color: white !important;
  }
</style>

<a href="{% url 'matches_app:substitution_panel' match.id %}";>SUB</a>
<hr>

<div class="tag-panel" id="player-panel">
 
  {% for player in players %}
    {% with total=outcome_counts|get_item_or:player.id %}
      {% with count=total.total|default:0 %}
        <button class="player-btn" data-player-id="{{ player.id }}">
          {{ player.name|slice:":10"  }} <span class="count-badge">{{ count }}</span>
        </button>
      {% endwith %}
    {% endwith %}
  {% endfor %}

</div>

<div id="tagging-section" style="display:none;">
  <h3>Select Outcome</h3>
  <div id="outcome-panel" class="tag-panel">
    {% for value, label in outcomes %}
      {% with count=total_outcome_counts|get_item:value|stringformat:"s"|default:0 %}
        <button class="outcome-btn" data-outcome="{{ value }}">
          {{ label }} <span class="count-badge">{{ count }}</span>
        </button>
      {% endwith %}
    {% endfor %}
  </div>


  <h3>Select Delivery Type</h3>
  <div id="delivery-panel" class="tag-panel">
    {% for value, label in delivery_types %}
      <button class="delivery-btn" data-delivery-type="{{ value }}">{{ label }}</button>
    {% endfor %}
  </div>
</div>

<hr>

<h3>Live Event Log</h3>
<div class="event-log" id="event-log"></div>

<script>
let timer = 0;
let interval = null;
let isPaused = false;
let selectedPlayer = null, selectedOutcome = null, selectedDeliveryType = null;
const matchId = {{ match.id }};

// Utilities
function formatTime(seconds) {
  let m = String(Math.floor(seconds / 60)).padStart(2, '0');
  let s = String(seconds % 60).padStart(2, '0');
  return `${m}:${s}`;
}

function updateTimerDisplay() {
  document.getElementById('timer-display').innerText = formatTime(timer);
  sessionStorage.setItem('tagging-timer', timer);
}

function startTimer() {
  interval = setInterval(() => {
    if (!isPaused) {
      timer++;
      updateTimerDisplay();
    }
  }, 1000);
}

function clearSelected(selector) {
  document.querySelectorAll(selector).forEach(btn => btn.classList.remove('selected'));
}

// Restore time + fetch live state from backend
window.onload = function () {
  timer = parseInt(sessionStorage.getItem('tagging-timer')) || 0;
  updateTimerDisplay();
  startTimer();

  // Fetch live state
  fetch(`/tagging/live_state/${matchId}/`)
    .then(res => res.json())
    .then(data => {
      if (data.timer > timer) {
        timer = data.timer;
        updateTimerDisplay();
      }

      const log = document.getElementById('event-log');
      log.innerHTML = '';
      data.events.forEach(ev => {
        log.innerHTML += `<div><b>${ev.player_name}</b> - ${ev.outcome} - ${ev.delivery_type} at ${String(ev.minute).padStart(2,'0')}:${String(ev.second).padStart(2,'0')}</div>`;
      });
    });
};

document.getElementById('pause-btn').onclick = () => isPaused = true;
document.getElementById('resume-btn').onclick = () => isPaused = false;
document.getElementById('reset-btn').onclick = () => {
  timer = 0;
  updateTimerDisplay();
  sessionStorage.setItem('tagging-timer', 0);
};

// Player
document.querySelectorAll('.player-btn').forEach(btn => {
  btn.onclick = () => {
    selectedPlayer = btn.dataset.playerId;
    document.getElementById('tagging-section').style.display = 'block';
    clearSelected('.player-btn');
    btn.classList.add('selected');
  };
});

// Outcome
document.querySelectorAll('.outcome-btn').forEach(btn => {
  btn.onclick = () => {
    selectedOutcome = btn.dataset.outcome;
    clearSelected('.outcome-btn');
    btn.classList.add('selected');
  };
});


// Delivery Type
document.querySelectorAll('.delivery-btn').forEach(btn => {
  btn.onclick = () => {
    selectedDeliveryType = btn.dataset.deliveryType;
    clearSelected('.delivery-btn');
    btn.classList.add('selected');

    if (selectedPlayer && selectedOutcome && selectedDeliveryType) {
      const now = new Date();
      const data = {
        match_id: matchId,
        player_id: selectedPlayer,
        outcome: selectedOutcome,
        delivery_type: selectedDeliveryType,
        minute: Math.floor(timer / 60),
        second: timer % 60,
        timestamp: now.toISOString()
      };

      fetch("{% url 'tagging_app:save_attempt_to_goal'  %}", {
      
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(json => {
        if (json.status === 'ok') {
          const log = document.getElementById('event-log');
          log.innerHTML = `<div><b>${json.player_name}</b> - ${selectedOutcome} - ${selectedDeliveryType} at ${formatTime(timer)}</div>` + log.innerHTML;

          // Reset selections
          selectedPlayer = selectedOutcome = selectedBodyPart = selectedDeliveryType = null;
          clearSelected('.player-btn');
          clearSelected('.outcome-btn');
          clearSelected('.delivery-btn');
          document.getElementById('tagging-section').style.display = 'none';

          // Update count badges
          updateCounts(json.updated_counts, json.player_id);
        } else {
          alert(json.message);
        }
      });
    }
  };
});

// Update counts live
function updateCounts(updatedCounts, playerId) {
  const playerBtn = document.querySelector(`.player-btn[data-player-id="${playerId}"]`);
  if (playerBtn) {
    const badge = playerBtn.querySelector('.count-badge');
    if (badge) badge.textContent = updatedCounts.total || 0;
  }

  for (const outcome in updatedCounts) {
    if (outcome === 'total') continue;
    const btn = document.querySelector(`.outcome-btn[data-outcome="${outcome}"]`);
    if (btn) {
      const badge = btn.querySelector('.count-badge');
      if (badge) badge.textContent = updatedCounts[outcome];
    }
  }
}
</script>
{% endblock %}

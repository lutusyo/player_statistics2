{% load static %}


{% load static %}
{% load custom_filters %}

{% block content %}
<style>
body, html {
  margin: 0;
  padding: 0;
  height: 100%;
}

.container {
  display: flex;
  flex-direction: column;
  height: 100vh; /* Fill screen */
  overflow: hidden;
}

.header, .timer {
  flex: 0 0 auto;
  padding: 10px;
}

.panels {
  flex: 1 1 auto; /* Take remaining space */
  display: grid;
  grid-template-columns: 1fr 1fr; /* Two panels side by side */
  gap: 10px;
  padding: 10px;
  overflow-y: auto; /* Scroll if too tall */
}

/* Player grids inside each panel */
.player-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4x4 layout */
  gap: 10px;
}

/* Mobile view: stack everything */
@media (max-width: 768px) {
  .panels {
    grid-template-columns: 1fr; /* Single column */
  }
  .player-grid {
    grid-template-columns: repeat(2, 1fr); /* smaller grid for mobile */
  }
}

/* Player buttons styling */
.player-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10px;
  background-color: lightblue;
  border: none;
  cursor: pointer;
  border-radius: 5px;
  text-align: center;
  font-weight: bold;
}

.player-btn img {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 5px;
}

.player-btn.active, .player-btn.selected {
  background-color: green !important;
  color: white;
}
</style>


<a href="{% url 'lineup_app:substitution_panel' match.id %}">SUB</a>
<hr>

<div class="tag-panel" id="player-panel">
  {% for player in players %}
    {% with total=outcome_counts|get_item_or:player.id %}
      {% with count=total.total|default:0 %}
        <button class="player-btn" data-player-id="{{ player.id }}">
          {% if player.photo %}
            <img src="{{ player.photo.url }}" alt="{{ player.name }}">
          {% else %}
            <img src="{% static 'default_player.png' %}" alt="{{ player.name }}">
          {% endif %}
          {{ player.name|slice:":10" }}
          <span class="count-badge">{{ count }}</span>
        </button>
      {% endwith %}
    {% endwith %}
  {% endfor %}
</div>

<div id="tagging-section" style="display:none;">
  <h3>Select Outcome</h3>
  <div id="outcome-panel" class="tag-panel">
    {% for value, label in outcomes %}
      {% with count=total_outcome_counts|get_item:value|stringformat:"s"|default:0 %}
        <button class="outcome-btn" data-outcome="{{ value }}">
          {{ label }} <span class="count-badge">{{ count }}</span>
        </button>
      {% endwith %}
    {% endfor %}
  </div>

  <h3>Select Delivery Type</h3>
  <div id="delivery-panel" class="tag-panel">
    {% for value, label in delivery_types %}
      <button class="delivery-btn" data-delivery-type="{{ value }}">{{ label }}</button>
    {% endfor %}
  </div>
</div>

<hr>

<h3>Live Event Log</h3>
<div class="event-log" id="event-log"></div>




<script>
let timer = 0;
let interval = null;
let isPaused = false;
let selectedPlayer = null, selectedOutcome = null, selectedDeliveryType = null;
const matchId = {{ match.id }};

// Utilities
function formatTime(seconds) {
  let m = String(Math.floor(seconds / 60)).padStart(2, '0');
  let s = String(seconds % 60).padStart(2, '0');
  return `${m}:${s}`;
}

function updateTimerDisplay() {
  document.getElementById('timer-display').innerText = formatTime(timer);
  sessionStorage.setItem('tagging-timer', timer);
}

function startTimer() {
  interval = setInterval(() => {
    if (!isPaused) {
      timer++;
      updateTimerDisplay();
    }
  }, 1000);
}

function clearSelected(selector) {
  document.querySelectorAll(selector).forEach(btn => btn.classList.remove('selected'));
}

// Restore time + fetch live state from backend
window.onload = function () {
  timer = parseInt(sessionStorage.getItem('tagging-timer')) || 0;
  updateTimerDisplay();
  startTimer();

  // Fetch live state
  fetch(`/tagging/live_state/${matchId}/`)
    .then(res => res.json())
    .then(data => {
      if (data.timer > timer) {
        timer = data.timer;
        updateTimerDisplay();
      }

      const log = document.getElementById('event-log');
      log.innerHTML = '';
      data.events.forEach(ev => {
        log.innerHTML += `<div><b>${ev.player_name}</b> - ${ev.outcome} - ${ev.delivery_type} at ${String(ev.minute).padStart(2,'0')}:${String(ev.second).padStart(2,'0')}</div>`;
      });
    });
};

document.getElementById('pause-btn').onclick = () => isPaused = true;
document.getElementById('resume-btn').onclick = () => isPaused = false;
document.getElementById('reset-btn').onclick = () => {
  timer = 0;
  updateTimerDisplay();
  sessionStorage.setItem('tagging-timer', 0);
};

// Player
document.querySelectorAll('.player-btn').forEach(btn => {
  btn.onclick = () => {
    selectedPlayer = btn.dataset.playerId;
    document.getElementById('tagging-section').style.display = 'block';
    clearSelected('.player-btn');
    btn.classList.add('selected');
  };
});

// Outcome
document.querySelectorAll('.outcome-btn').forEach(btn => {
  btn.onclick = () => {
    selectedOutcome = btn.dataset.outcome;
    clearSelected('.outcome-btn');
    btn.classList.add('selected');
  };
});


// Delivery Type
document.querySelectorAll('.delivery-btn').forEach(btn => {
  btn.onclick = () => {
    selectedDeliveryType = btn.dataset.deliveryType;
    clearSelected('.delivery-btn');
    btn.classList.add('selected');

    if (selectedPlayer && selectedOutcome && selectedDeliveryType) {
      const now = new Date();
      const data = {
        match_id: matchId,
        player_id: selectedPlayer,
        outcome: selectedOutcome,
        delivery_type: selectedDeliveryType,
        minute: Math.floor(timer / 60),
        second: timer % 60,
        timestamp: now.toISOString()
      };

      fetch("{% url 'tagging_app:save_attempt_to_goal'  %}", {
      
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(json => {
        if (json.status === 'ok') {
          const log = document.getElementById('event-log');
          log.innerHTML = `<div><b>${json.player_name}</b> - ${selectedOutcome} - ${selectedDeliveryType} at ${formatTime(timer)}</div>` + log.innerHTML;

          // Reset selections
          selectedPlayer = selectedOutcome = selectedBodyPart = selectedDeliveryType = null;
          clearSelected('.player-btn');
          clearSelected('.outcome-btn');
          clearSelected('.delivery-btn');
          document.getElementById('tagging-section').style.display = 'none';

          // Update count badges
          updateCounts(json.updated_counts, json.player_id);
        } else {
          alert(json.message);
        }
      });
    }
  };
});

// Update counts live
function updateCounts(updatedCounts, playerId) {
  const playerBtn = document.querySelector(`.player-btn[data-player-id="${playerId}"]`);
  if (playerBtn) {
    const badge = playerBtn.querySelector('.count-badge');
    if (badge) badge.textContent = updatedCounts.total || 0;
  }

  for (const outcome in updatedCounts) {
    if (outcome === 'total') continue;
    const btn = document.querySelector(`.outcome-btn[data-outcome="${outcome}"]`);
    if (btn) {
      const badge = btn.querySelector('.count-badge');
      if (badge) badge.textContent = updatedCounts[outcome];
    }
  }
}
</script>
{% endblock %}

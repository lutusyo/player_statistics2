{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-3">

    <h4 class="mb-3">Live Match Tagging</h4>

    <div class="row">

        <!-- HOME TEAM -->
        <div class="col-md-4">
            <h6 class="text-center">{{ match.home_team.name }}</h6>

            <ul class="list-group">
                {% for lineup in home_lineups %}
                <li class="list-group-item player" data-id="{{ lineup.id }}">
                    {{ lineup.player.name }}
                </li>
                {% empty %}
                <li class="list-group-item text-muted">No players</li>
                {% endfor %}
            </ul>
        </div>

        <!-- ACTIONS -->
        <div class="col-md-4">
            <h6 class="text-center">Ball Action</h6>

            <div class="d-grid gap-2">
                {% for value,label in form.action_type.field.choices %}
                <button class="btn btn-outline-primary action-btn" data-action="{{ value }}">
                    {{ label }}
                </button>
                {% endfor %}
            </div>

            <div class="alert alert-info mt-3 text-center" id="status">
                Select Actor
            </div>
        </div>

        <!-- AWAY TEAM -->
        <div class="col-md-4">
            <h6 class="text-center">{{ match.away_team.name }}</h6>

            <ul class="list-group">
                {% for lineup in away_lineups %}
                <li class="list-group-item player" data-id="{{ lineup.id }}">
                    {{ lineup.player.name }}
                </li>
                {% empty %}
                <li class="list-group-item text-muted">No players</li>
                {% endfor %}
            </ul>
        </div>

    </div>

    <form id="hidden-form">
        {% csrf_token %}
        <input type="hidden" name="actor" id="actor">
        <input type="hidden" name="target" id="target">
        <input type="hidden" name="receiver" id="receiver">
        <input type="hidden" name="action_type" id="action_type">
    </form>

</div>

<style>
.player {
    cursor: pointer;
    transition: background 0.2s;
}

.actor {
    background-color: #198754 !important; /* green */
    color: white;
}

.target {
    background-color: #ffc107 !important; /* yellow */
    color: black;
}

.receiver {
    background-color: #0d6efd !important; /* blue */
    color: white;
}
</style>

<script>
let step = "actor";
let data = { actor: null, action: null, target: null, receiver: null };
const status = document.getElementById("status");

/* ---------- PLAYER CLICK ---------- */
document.querySelectorAll(".player").forEach(player => {
    player.addEventListener("click", () => {

        /* ACTOR */
        if (step === "actor") {
            resetUI();
            data.actor = player.dataset.id;
            player.classList.add("actor");
            step = "action";
            status.innerText = "Select Ball Action";
        }

        /* TARGET */
        else if (step === "target") {
            if (!data.action) return alert("Please select an action first!");
            data.target = player.dataset.id;
            player.classList.add("target");
            step = "receiver";
            status.innerText = "Select Receiver";
        }

        /* RECEIVER */
        else if (step === "receiver") {
            data.receiver = player.dataset.id;
            player.classList.add("receiver");
            saveEvent(); // AUTO SAVE
        }
    });
});

/* ---------- ACTION BUTTON ---------- */
document.querySelectorAll(".action-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        if (step !== "action") return;
        data.action = btn.dataset.action;
        btn.classList.add("active");
        step = "target";
        status.innerText = "Select Target";
    });
});

/* ---------- SAVE EVENT ---------- */
function saveEvent() {
    const formData = new FormData();
    formData.append("actor", data.actor);
    formData.append("target", data.target);
    formData.append("receiver", data.receiver);
    formData.append("action_type", data.action);
    formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);

    fetch("", {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: formData
    })
    .then(res => res.json())
    .then(resp => {
        if (resp.success) {
            resetAll();
        } else {
            alert("Error saving event");
        }
    })
    .catch(err => {
        console.error(err);
        alert("Server error");
    });
}

/* ---------- RESET EVERYTHING ---------- */
function resetAll() {
    step = "actor";
    data = { actor: null, action: null, target: null, receiver: null };
    document.querySelectorAll(".player").forEach(p => p.classList.remove("actor", "target", "receiver"));
    document.querySelectorAll(".action-btn").forEach(b => b.classList.remove("active"));
    status.innerText = "Select Actor";
}

/* ---------- RESET UI ONLY ---------- */
function resetUI() {
    document.querySelectorAll(".player").forEach(p => p.classList.remove("actor", "target", "receiver"));
}
</script>

{% endblock %}

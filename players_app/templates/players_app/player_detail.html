{% load static %}

{% block title %}{{ player.name }}{% endblock %}
<link rel="stylesheet" href="{% static 'players_app/css/player.css' %}">
<style>
/* --- Base styling --- */
.player-detail-wrapper {
    display: flex;
    gap: 20px;
    margin: 20px 0;
}

/* Sidebar */
.player-sidebar {
    width: 220px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    height: fit-content;
    flex-shrink: 0;
}

.player-sidebar h3 {
    font-size: 16px;
    margin-bottom: 10px;
}

.sidebar-player-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.sidebar-player-list li {
    margin-bottom: 10px;
}

.sidebar-player-photo {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 8px;
    margin-right: 10px;
}

.sidebar-player-name {
    font-size: 14px;
}

/* Profile & stats container */
.player-profile-container {
    flex: 1;
}

/* Player photo */
.player-photo-centered img {
    max-width: 220px;
    width: 100%;
    border-radius: 12px;
}

/* Toggle buttons */
.toggle-buttons {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    flex-wrap: wrap;
    justify-content: center;
}

.toggle-buttons button {
    padding: 10px 20px;
    border: none;
    background: #eee;
    cursor: pointer;
    font-weight: bold;
    border-radius: 8px;
    transition: 0.3s;
}

.toggle-buttons button.active {
    background: #007bff;
    color: white;
}

/* Player attribute grid */
.player-attributes-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.attribute-block {
    background: #f1f5f9;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
}

.attribute-block .label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 4px;
}

.attribute-block .value {
    font-weight: bold;
    font-size: 14px;
}

/* Stats table */
.stats-table-container {
    overflow-x: auto; /* Horizontal scroll on small devices */
}

.stats-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 14px;
    min-width: 800px; /* ensures scroll if table is wide */
}

.stats-table th, .stats-table td {
    padding: 10px;
    border: 1px solid #ccc;
    text-align: center;
}

.stats-table th {
    background-color: #007bff;
    color: white;
    text-transform: uppercase;
}

.stats-table tr:nth-child(even) td {
    background-color: #f1f1f1;
}

.stats-table tr:hover td {
    background-color: #e1eaff;
}

/* Sections */
.section { display: none; }
.section.active { display: block; }

/* --- Responsive adjustments --- */
@media (max-width: 1024px) {
    .player-detail-wrapper {
        flex-direction: column;
    }
    .player-sidebar {
        width: 100%;
        display: flex;
        overflow-x: auto;
        padding: 10px 5px;
        margin-bottom: 15px;
    }
    .sidebar-player-list {
        display: flex;
        gap: 10px;
    }
    .sidebar-player-list li {
        flex: 0 0 auto;
        text-align: center;
    }
    .sidebar-player-name {
        display: block;
        font-size: 12px;
    }
    .player-attributes-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 600px) {
    .player-attributes-grid {
        grid-template-columns: 1fr;
    }
    .toggle-buttons {
        gap: 5px;
    }
    .toggle-buttons button {
        flex: 1;
        font-size: 14px;
        padding: 8px 10px;
    }
}
</style>



<div class="player-detail-wrapper">

    <div class="player-sidebar">
        <h3>All ({{ player.age_group }}) players</h3>
        <ul class="sidebar-player-list">
            {% for related in related_players %}
                <li>
                    <a href="{% url 'players_app:player_detail' related.id %}">
                        <img src="{{ related.photo.url }}" alt="{{ related.name }}" class="sidebar-player-photo">
                        <span class="sidebar-player-name">{{ related.name }}</span>
                    </a>
                </li>
            {% endfor %}
        </ul>
    </div>

    <div class="player-profile-container">
        <div class="player-photo-centered">
            <img src="{{ player.photo.url }}" alt="{{ player.name }}">
        </div>

        <div class="toggle-buttons">
            <button id="profileBtn">Profile</button>
            <button id="statsBtn">Stats</button>
        </div>


        
        <div id="profileSection" class="section">

            <div class="player-attributes-grid">
            <div class="attribute-block"><p class="label">Position</p><p class="value blue-text">{{ player.position }}</p></div>
            <div class="attribute-block"><p class="label">Shirt</p><p class="value blue-text">{{ player.jersey_number }}</p></div>
            <div class="attribute-block"><p class="label">Birthdate</p><p class="value blue-text">{{ player.birthdate }}</p></div>
            <div class="attribute-block"><p class="label">Age</p><p class="value blue-text">{{ player.age_using_birthdate }} years</p></div>

            <div class="attribute-block">
                <p class="label">Height</p>
                <p class="value blue-text">
                    {% if latest_measurement %}{{ latest_measurement.height }} cm{% else %}-{% endif %}
                </p>
            </div>

            <div class="attribute-block">
                <p class="label">Weight</p>
                <p class="value blue-text">
                    {% if latest_measurement %}{{ latest_measurement.weight }} kg{% else %}-{% endif %}
                </p>
            </div>

            <div class="attribute-block">
                <p class="label">BMI</p>
                <p class="value blue-text">
                    {% if bmi %}{{ bmi }}{% else %}-{% endif %}
                </p>
            </div>

            <div class="attribute-block"><p class="label">Preferred Foot</p><p class="value blue-text">{{ player.foot_preference }}</p></div>
        </div>

        {% if last_three_measurements %}
        <h4>Last 3 Measurements</h4>
        <ul>
            {% for m in last_three_measurements %}
            <li>{{ m.date_measured }} â€” Height: {{ m.height }} cm, Weight: {{ m.weight }} kg, BMI: {{ m.bmi }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        {% include "matches_app/player_timeline.html" %}

    </div>










        <div id="statsSection" class="section">
            <div class="filter-container">
                <select id="seasonFilter" name="season" onchange="applyFilters()">
                    <option value="all" {% if selected_season == 'all' %}selected{% endif %}>All Seasons</option>
                    {% for season in seasons %}
                        <option value="{{ season }}" {% if selected_season == season %}selected{% endif %}>{{ season }}</option>
                    {% endfor %}
                </select>
                <select id="competitionFilter" name="competition" onchange="applyFilters()">
                    <option value="all" {% if selected_competition == 'all' %}selected{% endif %}>All Competitions</option>
                    {% for comp in competitions %}
                        <option value="{{ comp }}" {% if selected_competition == comp %}selected{% endif %}>{{ comp }}</option>
                    {% endfor %}
                </select>
            </div>


            <!-- Wrap table in a scroll container for mobile -->
            <div class="stats-table-container">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Competition</th>
                            <th>Apps</th>
                            <th>Mins</th>
                            <th>Goals</th>
                            <th>Assists</th>
                            <th>Starts</th>
                            <th>Sub In</th>
                            <th>Sub Out</th>
                            <th>Tackles Won</th>
                            <th>Tackles Lost</th>
                            <th>Yellow</th>
                            <th>Red</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if player_stats %}
                            {% for stat in player_stats %}
                            <tr>
                                <td>{{ stat.competition }}</td>
                                <td>{{ stat.appearances }}</td>
                                <td>{{ stat.minutes }}</td>
                                <td>{{ stat.goals }}</td>
                                <td>{{ stat.assists }}</td>
                                <td>{{ stat.starts }}</td>
                                <td>{{ stat.sub_in }}</td>
                                <td>{{ stat.sub_out }}</td>
                                <td>{{ stat.tackles_won }}</td>
                                <td>{{ stat.tackles_lost }}</td>
                                <td>{{ stat.yellow_cards }}</td>
                                <td>{{ stat.red_cards }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="12">No stats available.</td></tr>
                        {% endif %}

                        <tr style="font-weight: bold; background-color: #d9edf7;">
                            <td>Total</td>
                            <td>{{ totals.appearances }}</td>
                            <td>{{ totals.minutes }}</td>
                            <td>{{ totals.goals }}</td>
                            <td>{{ totals.assists }}</td>
                            <td>{{ totals.starts }}</td>
                            <td>{{ totals.sub_in }}</td>
                            <td>{{ totals.sub_out }}</td>
                            <td>{{ totals.tackles_won }}</td>
                            <td>{{ totals.tackles_lost }}</td>
                            <td>{{ totals.yellow_cards }}</td>
                            <td>{{ totals.red_cards }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <h3>Matches Played</h3>
            <div class="stats-table-container">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Opponent</th>
                        <th>Competition</th>
                        <th>Result</th>
                        <th>Minutes Played</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in matches_played %}
                    <tr>
                        <td>{{ item.match.date }}</td>
                        <td>{{ item.match.away_team }}</td>
                        <td>{{ item.match.competition_type }}</td>
                        <td>{{ item.match.home_score }} - {{ item.match.away_score }}</td>
                        <td>{{ item.minutes_played }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5">No matches played yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>


        </div>

    </div>
</div>

<script>
    // Handles filters
    function applyFilters() {
        const season = document.getElementById('seasonFilter').value;
        const competition = document.getElementById('competitionFilter').value;
        const url = new URL(window.location.href);
        url.searchParams.set('season', season);
        url.searchParams.set('competition', competition);
        url.searchParams.set('tab', 'stats');  // Stay on stats tab
        window.location.href = url.toString();
    }

    // Tab toggle
    function showSection(tab) {
        const profileBtn = document.getElementById("profileBtn");
        const statsBtn = document.getElementById("statsBtn");
        const profileSection = document.getElementById("profileSection");
        const statsSection = document.getElementById("statsSection");

        if (tab === 'stats') {
            statsSection.classList.add("active");
            profileSection.classList.remove("active");
            statsBtn.classList.add("active");
            profileBtn.classList.remove("active");
        } else {
            profileSection.classList.add("active");
            statsSection.classList.remove("active");
            profileBtn.classList.add("active");
            statsBtn.classList.remove("active");
        }
    }

    // Initialize tab on page load
    document.addEventListener("DOMContentLoaded", function () {
        showSection("{{ tab|default:'profile' }}");

        document.getElementById("profileBtn").addEventListener("click", function () {
            showSection('profile');
        });

        document.getElementById("statsBtn").addEventListener("click", function () {
            showSection('stats');
        });
    });
</script>
